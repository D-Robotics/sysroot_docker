
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>logilab.common.pytest &#8212; logilab common  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for logilab.common.pytest</h1><div class="highlight"><pre>
<span></span><span class="c1"># copyright 2003-2011 LOGILAB S.A. (Paris, FRANCE), all rights reserved.</span>
<span class="c1"># contact http://www.logilab.fr/ -- mailto:contact@logilab.fr</span>
<span class="c1">#</span>
<span class="c1"># This file is part of logilab-common.</span>
<span class="c1">#</span>
<span class="c1"># logilab-common is free software: you can redistribute it and/or modify it under</span>
<span class="c1"># the terms of the GNU Lesser General Public License as published by the Free</span>
<span class="c1"># Software Foundation, either version 2.1 of the License, or (at your option) any</span>
<span class="c1"># later version.</span>
<span class="c1">#</span>
<span class="c1"># logilab-common is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="c1"># ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
<span class="c1"># FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public License for more</span>
<span class="c1"># details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU Lesser General Public License along</span>
<span class="c1"># with logilab-common.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="sd">&quot;&quot;&quot;logilab-pytest is a tool that eases test running and debugging.</span>

<span class="sd">To be able to use logilab-pytest, you should either write tests using</span>
<span class="sd">the logilab.common.testlib&#39;s framework or the unittest module of the</span>
<span class="sd">Python&#39;s standard library.</span>

<span class="sd">You can customize logilab-pytest&#39;s behaviour by defining a ``pytestconf.py``</span>
<span class="sd">file somewhere in your test directory. In this file, you can add options or</span>
<span class="sd">change the way tests are run.</span>

<span class="sd">To add command line options, you must define a ``update_parser`` function in</span>
<span class="sd">your ``pytestconf.py`` file. The function must accept a single parameter</span>
<span class="sd">that will be the OptionParser&#39;s instance to customize.</span>

<span class="sd">If you wish to customize the tester, you&#39;ll have to define a class named</span>
<span class="sd">``CustomPyTester``. This class should extend the default `PyTester` class</span>
<span class="sd">defined in the logilab.common.pytest module. Take a look at the `PyTester` and</span>
<span class="sd">`DjangoTester` classes for more information about what can be done.</span>

<span class="sd">For instance, if you wish to add a custom -l option to specify a loglevel, you</span>
<span class="sd">could define the following ``pytestconf.py`` file ::</span>

<span class="sd">    import logging</span>
<span class="sd">    from logilab.common.pytest import PyTester</span>

<span class="sd">    def update_parser(parser):</span>
<span class="sd">        parser.add_option(&#39;-l&#39;, &#39;--loglevel&#39;, dest=&#39;loglevel&#39;, action=&#39;store&#39;,</span>
<span class="sd">                          choices=(&#39;debug&#39;, &#39;info&#39;, &#39;warning&#39;, &#39;error&#39;, &#39;critical&#39;),</span>
<span class="sd">                          default=&#39;critical&#39;, help=&quot;the default log level possible choices are &quot;</span>
<span class="sd">                          &quot;(&#39;debug&#39;, &#39;info&#39;, &#39;warning&#39;, &#39;error&#39;, &#39;critical&#39;)&quot;)</span>
<span class="sd">        return parser</span>


<span class="sd">    class CustomPyTester(PyTester):</span>
<span class="sd">        def __init__(self, cvg, options):</span>
<span class="sd">            super(CustomPyTester, self).__init__(cvg, options)</span>
<span class="sd">            loglevel = options.loglevel.upper()</span>
<span class="sd">            logger = logging.getLogger(&#39;erudi&#39;)</span>
<span class="sd">            logger.setLevel(logging.getLevelName(loglevel))</span>


<span class="sd">In your TestCase class you can then get the value of a specific option with</span>
<span class="sd">the ``optval`` method::</span>

<span class="sd">    class MyTestCase(TestCase):</span>
<span class="sd">        def test_foo(self):</span>
<span class="sd">            loglevel = self.optval(&#39;loglevel&#39;)</span>
<span class="sd">            # ...</span>


<span class="sd">You can also tag your tag your test for fine filtering</span>

<span class="sd">With those tag::</span>

<span class="sd">    from logilab.common.testlib import tag, TestCase</span>

<span class="sd">    class Exemple(TestCase):</span>

<span class="sd">        @tag(&#39;rouge&#39;, &#39;carre&#39;)</span>
<span class="sd">        def toto(self):</span>
<span class="sd">            pass</span>

<span class="sd">        @tag(&#39;carre&#39;, &#39;vert&#39;)</span>
<span class="sd">        def tata(self):</span>
<span class="sd">            pass</span>

<span class="sd">        @tag(&#39;rouge&#39;)</span>
<span class="sd">        def titi(test):</span>
<span class="sd">            pass</span>

<span class="sd">you can filter the function with a simple python expression</span>

<span class="sd"> * ``toto`` and ``titi`` match ``rouge``</span>
<span class="sd"> * ``toto``, ``tata`` and ``titi``, match ``rouge or carre``</span>
<span class="sd"> * ``tata`` and ``titi`` match``rouge ^ carre``</span>
<span class="sd"> * ``titi`` match ``rouge and not carre``</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">osp</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">process_time</span><span class="p">,</span> <span class="n">time</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">re</span> <span class="kn">import</span> <span class="n">Match</span>  <span class="c1"># type: ignore</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="c1"># Match is python &gt; 3.6 only.</span>
    <span class="c1">#</span>
    <span class="c1"># To be compatible with python &lt;= 3.6, and still provide some typing, we</span>
    <span class="c1"># manually define Match, in the same manner it is defined in the re module</span>
    <span class="c1"># of python &gt; 3.7</span>
    <span class="c1"># cf https://github.com/python/cpython/blob/3.7/Lib/re.py#L264</span>
    <span class="n">Match</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sre_compile</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">isgeneratorfunction</span><span class="p">,</span> <span class="n">isclass</span><span class="p">,</span> <span class="n">FrameInfo</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">shuffle</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">dropwhile</span>

<span class="c1"># mypy error: Module &#39;unittest.runner&#39; has no attribute &#39;_WritelnDecorator&#39;</span>
<span class="c1"># but it does</span>
<span class="kn">from</span> <span class="nn">unittest.runner</span> <span class="kn">import</span> <span class="n">_WritelnDecorator</span>  <span class="c1"># type: ignore</span>
<span class="kn">from</span> <span class="nn">unittest.suite</span> <span class="kn">import</span> <span class="n">TestSuite</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Generator</span><span class="p">,</span> <span class="n">Dict</span>

<span class="kn">from</span> <span class="nn">logilab.common.deprecation</span> <span class="kn">import</span> <span class="n">callable_deprecated</span>
<span class="kn">from</span> <span class="nn">logilab.common.fileutils</span> <span class="kn">import</span> <span class="n">abspath_listdir</span>
<span class="kn">from</span> <span class="nn">logilab.common</span> <span class="kn">import</span> <span class="n">textutils</span>
<span class="kn">from</span> <span class="nn">logilab.common</span> <span class="kn">import</span> <span class="n">testlib</span><span class="p">,</span> <span class="n">STD_BLACKLIST</span>

<span class="c1"># use the same unittest module as testlib</span>
<span class="kn">from</span> <span class="nn">logilab.common.testlib</span> <span class="kn">import</span> <span class="n">unittest</span><span class="p">,</span> <span class="n">start_interactive_mode</span>
<span class="kn">from</span> <span class="nn">logilab.common.testlib</span> <span class="kn">import</span> <span class="p">(</span>  <span class="c1"># noqa</span>
    <span class="n">nocoverage</span><span class="p">,</span>
    <span class="n">pause_trace</span><span class="p">,</span>
    <span class="n">replace_trace</span><span class="p">,</span>
<span class="p">)</span>  <span class="c1"># bwcompat</span>
<span class="kn">from</span> <span class="nn">logilab.common.debugger</span> <span class="kn">import</span> <span class="n">Debugger</span><span class="p">,</span> <span class="n">colorize_source</span>
<span class="kn">import</span> <span class="nn">doctest</span>

<span class="kn">import</span> <span class="nn">unittest</span> <span class="k">as</span> <span class="nn">unittest_legacy</span>

<span class="kn">from</span> <span class="nn">.decorators</span> <span class="kn">import</span> <span class="n">monkeypatch</span>

<span class="n">__docformat__</span> <span class="o">=</span> <span class="s2">&quot;restructuredtext en&quot;</span>

<span class="n">PYTEST_DOC</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;%prog [OPTIONS] [testfile [testpattern]]</span>

<span class="s2">examples:</span>

<span class="s2">logilab-pytest path/to/mytests.py</span>
<span class="s2">logilab-pytest path/to/mytests.py TheseTests</span>
<span class="s2">logilab-pytest path/to/mytests.py TheseTests.test_thisone</span>
<span class="s2">logilab-pytest path/to/mytests.py -m &#39;(not long and database) or regr&#39;</span>

<span class="s2">logilab-pytest one (will run both test_thisone and test_thatone)</span>
<span class="s2">logilab-pytest path/to/mytests.py -s not (will skip test_notthisone)</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">ENABLE_DBC</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">FILE_RESTART</span> <span class="o">=</span> <span class="s2">&quot;.pytest.restart&quot;</span>

<span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">unittest_legacy</span><span class="p">,</span> <span class="s2">&quot;__package__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">unittest2.suite</span> <span class="k">as</span> <span class="nn">unittest_suite</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;You have to install python-unittest2 to use this module&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># mypy: Name &#39;unittest_suite&#39; already defined (possibly by an import))</span>
    <span class="kn">import</span> <span class="nn">unittest.suite</span> <span class="k">as</span> <span class="nn">unittest_suite</span>  <span class="c1"># type: ignore</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">django</span>  <span class="c1"># noqa</span>
    <span class="kn">from</span> <span class="nn">logilab.common.modutils</span> <span class="kn">import</span> <span class="n">modpath_from_file</span><span class="p">,</span> <span class="n">load_module_from_modpath</span>

    <span class="n">DJANGO_FOUND</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">DJANGO_FOUND</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">CONF_FILE</span> <span class="o">=</span> <span class="s2">&quot;pytestconf.py&quot;</span>

<span class="n">TESTFILE_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^((unit)?test.*|smoketest)\.py$&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="this_is_a_testfile"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.this_is_a_testfile">[docs]</a><span class="k">def</span> <span class="nf">this_is_a_testfile</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Match</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;returns True if `filename` seems to be a test file&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">TESTFILE_RE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span></div>


<span class="n">TESTDIR_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;^(unit)?tests?$&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="this_is_a_testdir"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.this_is_a_testdir">[docs]</a><span class="k">def</span> <span class="nf">this_is_a_testdir</span><span class="p">(</span><span class="n">dirpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Match</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;returns True if `filename` seems to be a test directory&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">TESTDIR_RE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">dirpath</span><span class="p">))</span></div>


<div class="viewcode-block" id="load_pytest_conf"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.load_pytest_conf">[docs]</a><span class="k">def</span> <span class="nf">load_pytest_conf</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;loads a ``pytestconf.py`` file and update default parser</span>
<span class="sd">    and / or tester.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">namespace</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">exec</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">namespace</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;update_parser&quot;</span> <span class="ow">in</span> <span class="n">namespace</span><span class="p">:</span>
        <span class="n">namespace</span><span class="p">[</span><span class="s2">&quot;update_parser&quot;</span><span class="p">](</span><span class="n">parser</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">namespace</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CustomPyTester&quot;</span><span class="p">,</span> <span class="n">PyTester</span><span class="p">)</span></div>


<div class="viewcode-block" id="project_root"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.project_root">[docs]</a><span class="k">def</span> <span class="nf">project_root</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">projdir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;try to find project&#39;s root and add it to sys.path&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">projdir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">projdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="n">previousdir</span> <span class="o">=</span> <span class="n">curdir</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">projdir</span><span class="p">)</span>
    <span class="n">testercls</span> <span class="o">=</span> <span class="n">PyTester</span>
    <span class="n">conf_file_path</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">curdir</span><span class="p">,</span> <span class="n">CONF_FILE</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">osp</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">conf_file_path</span><span class="p">):</span>
        <span class="n">testercls</span> <span class="o">=</span> <span class="n">load_pytest_conf</span><span class="p">(</span><span class="n">conf_file_path</span><span class="p">,</span> <span class="n">parser</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">this_is_a_testdir</span><span class="p">(</span><span class="n">curdir</span><span class="p">)</span> <span class="ow">or</span> <span class="n">osp</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">curdir</span><span class="p">,</span> <span class="s2">&quot;__init__.py&quot;</span><span class="p">)):</span>
        <span class="n">newdir</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">curdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">newdir</span> <span class="o">==</span> <span class="n">curdir</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">previousdir</span> <span class="o">=</span> <span class="n">curdir</span>
        <span class="n">curdir</span> <span class="o">=</span> <span class="n">newdir</span>
        <span class="n">conf_file_path</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">curdir</span><span class="p">,</span> <span class="n">CONF_FILE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">osp</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">conf_file_path</span><span class="p">):</span>
            <span class="n">testercls</span> <span class="o">=</span> <span class="n">load_pytest_conf</span><span class="p">(</span><span class="n">conf_file_path</span><span class="p">,</span> <span class="n">parser</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">previousdir</span><span class="p">,</span> <span class="n">testercls</span></div>


<div class="viewcode-block" id="GlobalTestReport"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.GlobalTestReport">[docs]</a><span class="k">class</span> <span class="nc">GlobalTestReport</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;this class holds global test statistics&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ran</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skipped</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ttime</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctime</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modulescount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errmodules</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="GlobalTestReport.feed"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.GlobalTestReport.feed">[docs]</a>    <span class="k">def</span> <span class="nf">feed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">testresult</span><span class="p">,</span> <span class="n">ttime</span><span class="p">,</span> <span class="n">ctime</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;integrates new test information into internal statistics&quot;&quot;&quot;</span>
        <span class="n">ran</span> <span class="o">=</span> <span class="n">testresult</span><span class="o">.</span><span class="n">testsRun</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ran</span> <span class="o">+=</span> <span class="n">ran</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skipped</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">testresult</span><span class="p">,</span> <span class="s2">&quot;skipped&quot;</span><span class="p">,</span> <span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failures</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">testresult</span><span class="o">.</span><span class="n">failures</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">testresult</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ttime</span> <span class="o">+=</span> <span class="n">ttime</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctime</span> <span class="o">+=</span> <span class="n">ctime</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modulescount</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">testresult</span><span class="o">.</span><span class="n">wasSuccessful</span><span class="p">():</span>
            <span class="n">problems</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">testresult</span><span class="o">.</span><span class="n">failures</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">testresult</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errmodules</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="n">problems</span><span class="p">,</span> <span class="n">ran</span><span class="p">))</span></div>

<div class="viewcode-block" id="GlobalTestReport.failed_to_test_module"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.GlobalTestReport.failed_to_test_module">[docs]</a>    <span class="k">def</span> <span class="nf">failed_to_test_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;called when the test module could not be imported by unittest&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modulescount</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ran</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errmodules</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span></div>

<div class="viewcode-block" id="GlobalTestReport.skip_module"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.GlobalTestReport.skip_module">[docs]</a>    <span class="k">def</span> <span class="nf">skip_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modulescount</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ran</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errmodules</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;this is just presentation stuff&quot;&quot;&quot;</span>
        <span class="n">line1</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Ran </span><span class="si">%s</span><span class="s2"> test cases in </span><span class="si">%.2f</span><span class="s2">s (</span><span class="si">%.2f</span><span class="s2">s CPU)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ran</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttime</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctime</span><span class="p">)]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
            <span class="n">line1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> errors&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">failures</span><span class="p">:</span>
            <span class="n">line1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> failures&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">failures</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skipped</span><span class="p">:</span>
            <span class="n">line1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> skipped&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">skipped</span><span class="p">)</span>
        <span class="n">modulesok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modulescount</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errmodules</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">failures</span><span class="p">:</span>
            <span class="n">line2</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> modules OK (</span><span class="si">%s</span><span class="s2"> failed)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">modulesok</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errmodules</span><span class="p">))</span>
            <span class="n">descr</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> [</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="n">info</span> <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">errmodules</span><span class="p">])</span>
            <span class="n">line3</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">failures: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">descr</span>
        <span class="k">elif</span> <span class="n">modulesok</span><span class="p">:</span>
            <span class="n">line2</span> <span class="o">=</span> <span class="s2">&quot;All </span><span class="si">%s</span><span class="s2"> modules OK&quot;</span> <span class="o">%</span> <span class="n">modulesok</span>
            <span class="n">line3</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line1</span><span class="p">),</span> <span class="n">line2</span><span class="p">,</span> <span class="n">line3</span><span class="p">)</span></div>


<div class="viewcode-block" id="remove_local_modules_from_sys"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.remove_local_modules_from_sys">[docs]</a><span class="k">def</span> <span class="nf">remove_local_modules_from_sys</span><span class="p">(</span><span class="n">testdir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;remove all modules from cache that come from `testdir`</span>

<span class="sd">    This is used to avoid strange side-effects when using the</span>
<span class="sd">    testall() mode of pytest.</span>
<span class="sd">    For instance, if we run pytest on this tree::</span>

<span class="sd">      A/test/test_utils.py</span>
<span class="sd">      B/test/test_utils.py</span>

<span class="sd">    we **have** to clean sys.modules to make sure the correct test_utils</span>
<span class="sd">    module is ran in B</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">modname</span><span class="p">,</span> <span class="n">mod</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">mod</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="s2">&quot;__file__&quot;</span><span class="p">):</span>
            <span class="c1"># this is the case of some built-in modules like sys, imp, marshal</span>
            <span class="k">continue</span>
        <span class="n">modfile</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="vm">__file__</span>
        <span class="c1"># if modfile is not an absolute path, it was probably loaded locally</span>
        <span class="c1"># during the tests</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">osp</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">modfile</span><span class="p">)</span> <span class="ow">or</span> <span class="n">modfile</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">testdir</span><span class="p">):</span>
            <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">modname</span><span class="p">]</span></div>


<div class="viewcode-block" id="PyTester"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.PyTester">[docs]</a><span class="k">class</span> <span class="nc">PyTester</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;encapsulates testrun logic&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cvg</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report</span> <span class="o">=</span> <span class="n">GlobalTestReport</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cvg</span> <span class="o">=</span> <span class="n">cvg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">firstwrite</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_errcode</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="PyTester.show_report"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.PyTester.show_report">[docs]</a>    <span class="k">def</span> <span class="nf">show_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;prints the report and returns appropriate exitcode&quot;&quot;&quot;</span>
        <span class="c1"># everything has been ran, print report</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*&quot;</span> <span class="o">*</span> <span class="mi">79</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">)</span></div>

<div class="viewcode-block" id="PyTester.get_errcode"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.PyTester.get_errcode">[docs]</a>    <span class="k">def</span> <span class="nf">get_errcode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># errcode set explicitly</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_errcode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_errcode</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">failures</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">errors</span></div>

<div class="viewcode-block" id="PyTester.set_errcode"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.PyTester.set_errcode">[docs]</a>    <span class="k">def</span> <span class="nf">set_errcode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">errcode</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_errcode</span> <span class="o">=</span> <span class="n">errcode</span></div>

    <span class="n">errcode</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_errcode</span><span class="p">,</span> <span class="n">set_errcode</span><span class="p">)</span>

<div class="viewcode-block" id="PyTester.testall"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.PyTester.testall">[docs]</a>    <span class="k">def</span> <span class="nf">testall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exitfirst</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;walks through current working directory, finds something</span>
<span class="sd">        which can be considered as a testdir and runs every test there</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">here</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">skipped</span> <span class="ow">in</span> <span class="n">STD_BLACKLIST</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">skipped</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
                    <span class="n">dirs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">skipped</span><span class="p">)</span>
            <span class="n">basename</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">this_is_a_testdir</span><span class="p">(</span><span class="n">basename</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;going into&quot;</span><span class="p">,</span> <span class="n">dirname</span><span class="p">)</span>
                <span class="c1"># we found a testdir, let&#39;s explore it !</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">testonedir</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">exitfirst</span><span class="p">):</span>
                    <span class="k">break</span>
                <span class="n">dirs</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">ran</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;no test dir found testing here:&quot;</span><span class="p">,</span> <span class="n">here</span><span class="p">)</span>
            <span class="c1"># if no test was found during the visit, consider</span>
            <span class="c1"># the local directory as a test directory even if</span>
            <span class="c1"># it doesn&#39;t have a traditional test directory name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">testonedir</span><span class="p">(</span><span class="n">here</span><span class="p">)</span></div>

<div class="viewcode-block" id="PyTester.testonedir"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.PyTester.testonedir">[docs]</a>    <span class="k">def</span> <span class="nf">testonedir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">testdir</span><span class="p">,</span> <span class="n">exitfirst</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;finds each testfile in the `testdir` and runs it</span>

<span class="sd">        return true when all tests has been executed, false if exitfirst and</span>
<span class="sd">        some test has failed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">abspath_listdir</span><span class="p">(</span><span class="n">testdir</span><span class="p">)</span>
        <span class="n">shuffle</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">this_is_a_testfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">exitfirst</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">restart</span><span class="p">:</span>
                    <span class="c1"># overwrite restart file</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">restartfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">FILE_RESTART</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
                        <span class="n">restartfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;Error while overwriting succeeded test file :&quot;</span><span class="p">,</span>
                            <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">FILE_RESTART</span><span class="p">),</span>
                            <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">__stderr__</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="k">raise</span>
                <span class="c1"># run test and collect information</span>
                <span class="n">prog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testfile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">batchmode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">exitfirst</span> <span class="ow">and</span> <span class="p">(</span><span class="n">prog</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">prog</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">wasSuccessful</span><span class="p">()):</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">firstwrite</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># clean local modules</span>
        <span class="n">remove_local_modules_from_sys</span><span class="p">(</span><span class="n">testdir</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="PyTester.testfile"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.PyTester.testfile">[docs]</a>    <span class="k">def</span> <span class="nf">testfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">batchmode</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;runs every test in `filename`</span>

<span class="sd">        :param filename: an absolute path pointing to a unittest file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">dirname</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dirname</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
        <span class="c1"># overwrite restart file if it has not been done already</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">exitfirst</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">restart</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">firstwrite</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">restartfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">FILE_RESTART</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
                <span class="n">restartfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;Error while overwriting succeeded test file :&quot;</span><span class="p">,</span>
                    <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">FILE_RESTART</span><span class="p">),</span>
                    <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">__stderr__</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">raise</span>
        <span class="n">modname</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">((</span><span class="s2">&quot;  </span><span class="si">%s</span><span class="s2">  &quot;</span> <span class="o">%</span> <span class="n">osp</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">70</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">__stderr__</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tstart</span><span class="p">,</span> <span class="n">cstart</span> <span class="o">=</span> <span class="n">time</span><span class="p">(),</span> <span class="n">process_time</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">testprog</span> <span class="o">=</span> <span class="n">SkipAwareTestProgram</span><span class="p">(</span>
                    <span class="n">modname</span><span class="p">,</span>
                    <span class="n">batchmode</span><span class="o">=</span><span class="n">batchmode</span><span class="p">,</span>
                    <span class="n">cvg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cvg</span><span class="p">,</span>
                    <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                    <span class="n">outstream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">SystemExit</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">errcode</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">code</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="n">testlib</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Module skipped:&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">skip_module</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">failed_to_test_module</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;unhandled exception occurred while testing&quot;</span><span class="p">,</span> <span class="n">modname</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="kn">import</span> <span class="nn">traceback</span>

                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">tend</span><span class="p">,</span> <span class="n">cend</span> <span class="o">=</span> <span class="n">time</span><span class="p">(),</span> <span class="n">process_time</span><span class="p">()</span>
            <span class="n">ttime</span><span class="p">,</span> <span class="n">ctime</span> <span class="o">=</span> <span class="p">(</span><span class="n">tend</span> <span class="o">-</span> <span class="n">tstart</span><span class="p">),</span> <span class="p">(</span><span class="n">cend</span> <span class="o">-</span> <span class="n">cstart</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">testprog</span><span class="o">.</span><span class="n">result</span><span class="p">,</span> <span class="n">ttime</span><span class="p">,</span> <span class="n">ctime</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">testprog</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dirname</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">here</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DjangoTester"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.DjangoTester">[docs]</a><span class="k">class</span> <span class="nc">DjangoTester</span><span class="p">(</span><span class="n">PyTester</span><span class="p">):</span>
<div class="viewcode-block" id="DjangoTester.load_django_settings"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.DjangoTester.load_django_settings">[docs]</a>    <span class="k">def</span> <span class="nf">load_django_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dirname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;try to find project&#39;s setting and load it&quot;&quot;&quot;</span>
        <span class="n">curdir</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">osp</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">curdir</span><span class="p">,</span> <span class="s2">&quot;settings.py&quot;</span><span class="p">))</span> <span class="ow">and</span> <span class="n">osp</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span>
            <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">curdir</span><span class="p">,</span> <span class="s2">&quot;__init__.py&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">newdir</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">curdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">newdir</span> <span class="o">==</span> <span class="n">curdir</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;could not find settings.py&quot;</span><span class="p">)</span>
            <span class="n">curdir</span> <span class="o">=</span> <span class="n">newdir</span>
        <span class="c1"># late django initialization</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">load_module_from_modpath</span><span class="p">(</span><span class="n">modpath_from_file</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">curdir</span><span class="p">,</span> <span class="s2">&quot;settings.py&quot;</span><span class="p">)))</span>
        <span class="kn">from</span> <span class="nn">django.core.management</span> <span class="kn">import</span> <span class="n">setup_environ</span>

        <span class="n">setup_environ</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">settings</span>
        <span class="c1"># add settings dir to pythonpath since it&#39;s the project&#39;s root</span>
        <span class="k">if</span> <span class="n">curdir</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">curdir</span><span class="p">)</span></div>

<div class="viewcode-block" id="DjangoTester.before_testfile"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.DjangoTester.before_testfile">[docs]</a>    <span class="k">def</span> <span class="nf">before_testfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Those imports must be done **after** setup_environ was called</span>
        <span class="kn">from</span> <span class="nn">django.test.utils</span> <span class="kn">import</span> <span class="n">setup_test_environment</span>
        <span class="kn">from</span> <span class="nn">django.test.utils</span> <span class="kn">import</span> <span class="n">create_test_db</span>

        <span class="n">setup_test_environment</span><span class="p">()</span>
        <span class="n">create_test_db</span><span class="p">(</span><span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">TEST_DATABASE_NAME</span></div>

<div class="viewcode-block" id="DjangoTester.after_testfile"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.DjangoTester.after_testfile">[docs]</a>    <span class="k">def</span> <span class="nf">after_testfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Those imports must be done **after** setup_environ was called</span>
        <span class="kn">from</span> <span class="nn">django.test.utils</span> <span class="kn">import</span> <span class="n">teardown_test_environment</span>
        <span class="kn">from</span> <span class="nn">django.test.utils</span> <span class="kn">import</span> <span class="n">destroy_test_db</span>

        <span class="n">teardown_test_environment</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;destroying&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbname</span><span class="p">)</span>
        <span class="n">destroy_test_db</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbname</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="DjangoTester.testall"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.DjangoTester.testall">[docs]</a>    <span class="k">def</span> <span class="nf">testall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exitfirst</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;walks through current working directory, finds something</span>
<span class="sd">        which can be considered as a testdir and runs every test there</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()):</span>
            <span class="k">for</span> <span class="n">skipped</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;CVS&quot;</span><span class="p">,</span> <span class="s2">&quot;.svn&quot;</span><span class="p">,</span> <span class="s2">&quot;.hg&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">skipped</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
                    <span class="n">dirs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">skipped</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;tests.py&quot;</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">testonedir</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">exitfirst</span><span class="p">):</span>
                    <span class="k">break</span>
                <span class="n">dirs</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">basename</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">basename</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;tests&quot;</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;going into&quot;</span><span class="p">,</span> <span class="n">dirname</span><span class="p">)</span>
                    <span class="c1"># we found a testdir, let&#39;s explore it !</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">testonedir</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">exitfirst</span><span class="p">):</span>
                        <span class="k">break</span>
                    <span class="n">dirs</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="DjangoTester.testonedir"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.DjangoTester.testonedir">[docs]</a>    <span class="k">def</span> <span class="nf">testonedir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">testdir</span><span class="p">,</span> <span class="n">exitfirst</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;finds each testfile in the `testdir` and runs it</span>

<span class="sd">        return true when all tests has been executed, false if exitfirst and</span>
<span class="sd">        some test has failed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># special django behaviour : if tests are splitted in several files,</span>
        <span class="c1"># remove the main tests.py file and tests each test file separately</span>
        <span class="n">testfiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">fpath</span> <span class="k">for</span> <span class="n">fpath</span> <span class="ow">in</span> <span class="n">abspath_listdir</span><span class="p">(</span><span class="n">testdir</span><span class="p">)</span> <span class="k">if</span> <span class="n">this_is_a_testfile</span><span class="p">(</span><span class="n">fpath</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">testfiles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">testfiles</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">testdir</span><span class="p">,</span> <span class="s2">&quot;tests.py&quot;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">testfiles</span><span class="p">:</span>
            <span class="c1"># run test and collect information</span>
            <span class="n">prog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testfile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">batchmode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exitfirst</span> <span class="ow">and</span> <span class="p">(</span><span class="n">prog</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">prog</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">wasSuccessful</span><span class="p">()):</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># clean local modules</span>
        <span class="n">remove_local_modules_from_sys</span><span class="p">(</span><span class="n">testdir</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="DjangoTester.testfile"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.DjangoTester.testfile">[docs]</a>    <span class="k">def</span> <span class="nf">testfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">batchmode</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;runs every test in `filename`</span>

<span class="sd">        :param filename: an absolute path pointing to a unittest file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">dirname</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dirname</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_django_settings</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
        <span class="n">modname</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">((</span><span class="s2">&quot;  </span><span class="si">%s</span><span class="s2">  &quot;</span> <span class="o">%</span> <span class="n">osp</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">70</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tstart</span><span class="p">,</span> <span class="n">cstart</span> <span class="o">=</span> <span class="n">time</span><span class="p">(),</span> <span class="n">process_time</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">before_testfile</span><span class="p">()</span>
                <span class="n">testprog</span> <span class="o">=</span> <span class="n">SkipAwareTestProgram</span><span class="p">(</span><span class="n">modname</span><span class="p">,</span> <span class="n">batchmode</span><span class="o">=</span><span class="n">batchmode</span><span class="p">,</span> <span class="n">cvg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cvg</span><span class="p">)</span>
                <span class="n">tend</span><span class="p">,</span> <span class="n">cend</span> <span class="o">=</span> <span class="n">time</span><span class="p">(),</span> <span class="n">process_time</span><span class="p">()</span>
                <span class="n">ttime</span><span class="p">,</span> <span class="n">ctime</span> <span class="o">=</span> <span class="p">(</span><span class="n">tend</span> <span class="o">-</span> <span class="n">tstart</span><span class="p">),</span> <span class="p">(</span><span class="n">cend</span> <span class="o">-</span> <span class="n">cstart</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">testprog</span><span class="o">.</span><span class="n">result</span><span class="p">,</span> <span class="n">ttime</span><span class="p">,</span> <span class="n">ctime</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">testprog</span>
            <span class="k">except</span> <span class="ne">SystemExit</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">traceback</span>

                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">failed_to_test_module</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;unhandled exception occurred while testing&quot;</span><span class="p">,</span> <span class="n">modname</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;error: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">exc</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">after_testfile</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">dirname</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">here</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="make_parser"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.make_parser">[docs]</a><span class="k">def</span> <span class="nf">make_parser</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;creates the OptionParser instance&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">optparse</span> <span class="kn">import</span> <span class="n">OptionParser</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">(</span><span class="n">usage</span><span class="o">=</span><span class="n">PYTEST_DOC</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">newargs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">rebuild_cmdline</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;carry the option to unittest_main&quot;&quot;&quot;</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">newargs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">rebuild_and_store</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;carry the option to unittest_main and store</span>
<span class="sd">        the value on current parser</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">newargs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">option</span><span class="o">.</span><span class="n">dest</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">capture_and_rebuild</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
        <span class="n">rebuild_cmdline</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">parser</span><span class="p">)</span>

    <span class="c1"># logilab-pytest options</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span>
        <span class="s2">&quot;-t&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;testdir&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;directory where the tests will be found&quot;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span>
        <span class="s2">&quot;-d&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;dbc&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;enable design-by-contract&quot;</span>
    <span class="p">)</span>
    <span class="c1"># unittest_main options provided and passed through logilab-pytest</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span>
        <span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="s2">&quot;--verbose&quot;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">rebuild_cmdline</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;callback&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Verbose output&quot;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span>
        <span class="s2">&quot;-i&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--pdb&quot;</span><span class="p">,</span>
        <span class="n">callback</span><span class="o">=</span><span class="n">rebuild_and_store</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;pdb&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;callback&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable test failure inspection&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span>
        <span class="s2">&quot;-x&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--exitfirst&quot;</span><span class="p">,</span>
        <span class="n">callback</span><span class="o">=</span><span class="n">rebuild_and_store</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;exitfirst&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;callback&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Exit on first failure &quot;</span> <span class="s2">&quot;(only make sense when logilab-pytest run one test file)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span>
        <span class="s2">&quot;-R&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--restart&quot;</span><span class="p">,</span>
        <span class="n">callback</span><span class="o">=</span><span class="n">rebuild_and_store</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;restart&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;callback&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Restart tests from where it failed (implies exitfirst) &quot;</span>
        <span class="s2">&quot;(only make sense if tests previously ran with exitfirst only)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span>
        <span class="s2">&quot;--color&quot;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">rebuild_cmdline</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;callback&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;colorize tracebacks&quot;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span>
        <span class="s2">&quot;-s&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--skip&quot;</span><span class="p">,</span>
        <span class="c1"># XXX: I wish I could use the callback action but it</span>
        <span class="c1">#      doesn&#39;t seem to be able to get the value</span>
        <span class="c1">#      associated to the option</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;skipped&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;test names matching this name will be skipped &quot;</span>
        <span class="s2">&quot;to skip several patterns, use commas&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span>
        <span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="s2">&quot;--quiet&quot;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">rebuild_cmdline</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;callback&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Minimal output&quot;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span>
        <span class="s2">&quot;-P&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--profile&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;profile&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Profile execution and store data in the given file&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span>
        <span class="s2">&quot;-m&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--match&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;tags_pattern&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;only execute test whose tag match the current pattern&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">DJANGO_FOUND</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span>
            <span class="s2">&quot;-J&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--django&quot;</span><span class="p">,</span>
            <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;django&quot;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;use logilab-pytest for django test cases&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">parser</span></div>


<div class="viewcode-block" id="parseargs"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.parseargs">[docs]</a><span class="k">def</span> <span class="nf">parseargs</span><span class="p">(</span><span class="n">parser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse the command line and return (options processed), (options to pass to</span>
<span class="sd">    unittest_main()), (explicitfile or None).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># parse the command line</span>
    <span class="n">options</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">filenames</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;only one filename is acceptable&quot;</span><span class="p">)</span>
        <span class="n">explicitfile</span> <span class="o">=</span> <span class="n">filenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">args</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">explicitfile</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">explicitfile</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># someone wants DBC</span>
    <span class="n">testlib</span><span class="o">.</span><span class="n">ENABLE_DBC</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">dbc</span>
    <span class="n">newargs</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">newargs</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">skipped</span><span class="p">:</span>
        <span class="n">newargs</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--skip&quot;</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">skipped</span><span class="p">])</span>
    <span class="c1"># restart implies exitfirst</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">restart</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">exitfirst</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># append additional args to the new sys.argv and let unittest_main</span>
    <span class="c1"># do the rest</span>
    <span class="n">newargs</span> <span class="o">+=</span> <span class="n">args</span>
    <span class="k">return</span> <span class="n">options</span><span class="p">,</span> <span class="n">explicitfile</span></div>


<span class="nd">@callable_deprecated</span><span class="p">(</span><span class="s2">&quot;[logilab-common 1.3] logilab-pytest is deprecated, use another test runner&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">run</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">make_parser</span><span class="p">()</span>
    <span class="n">rootdir</span><span class="p">,</span> <span class="n">testercls</span> <span class="o">=</span> <span class="n">project_root</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
    <span class="n">options</span><span class="p">,</span> <span class="n">explicitfile</span> <span class="o">=</span> <span class="n">parseargs</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
    <span class="c1"># mock a new command line</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">newargs</span>
    <span class="n">cvg</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s2">&quot;&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">DJANGO_FOUND</span> <span class="ow">and</span> <span class="n">options</span><span class="o">.</span><span class="n">django</span><span class="p">:</span>
        <span class="n">tester</span> <span class="o">=</span> <span class="n">DjangoTester</span><span class="p">(</span><span class="n">cvg</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tester</span> <span class="o">=</span> <span class="n">testercls</span><span class="p">(</span><span class="n">cvg</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">explicitfile</span><span class="p">:</span>
        <span class="n">cmd</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">testfile</span><span class="p">,</span> <span class="p">(</span><span class="n">explicitfile</span><span class="p">,)</span>
    <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">testdir</span><span class="p">:</span>
        <span class="n">cmd</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">testonedir</span><span class="p">,</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">testdir</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">exitfirst</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cmd</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">testall</span><span class="p">,</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">exitfirst</span><span class="p">,)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">profile</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">hotshot</span>

                <span class="n">prof</span> <span class="o">=</span> <span class="n">hotshot</span><span class="o">.</span><span class="n">Profile</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">profile</span><span class="p">)</span>
                <span class="n">prof</span><span class="o">.</span><span class="n">runcall</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
                <span class="n">prof</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;profile data saved in&quot;</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">profile</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cmd</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">SystemExit</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">traceback</span>

            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">tester</span><span class="o">.</span><span class="n">show_report</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">tester</span><span class="o">.</span><span class="n">errcode</span><span class="p">)</span>


<div class="viewcode-block" id="SkipAwareTestProgram"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.SkipAwareTestProgram">[docs]</a><span class="k">class</span> <span class="nc">SkipAwareTestProgram</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestProgram</span><span class="p">):</span>
    <span class="c1"># XXX: don&#39;t try to stay close to unittest.py, use optparse</span>
    <span class="n">USAGE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">Usage: </span><span class="si">%(progName)s</span><span class="s2"> [options] [test] [...]</span>

<span class="s2">Options:</span>
<span class="s2">  -h, --help       Show this message</span>
<span class="s2">  -v, --verbose    Verbose output</span>
<span class="s2">  -i, --pdb        Enable test failure inspection</span>
<span class="s2">  -x, --exitfirst  Exit on first failure</span>
<span class="s2">  -s, --skip       skip test matching this pattern (no regexp for now)</span>
<span class="s2">  -q, --quiet      Minimal output</span>
<span class="s2">  --color          colorize tracebacks</span>

<span class="s2">  -m, --match      Run only test whose tag match this pattern</span>

<span class="s2">  -P, --profile    FILE: Run the tests using cProfile and saving results</span>
<span class="s2">                   in FILE</span>

<span class="s2">Examples:</span>
<span class="s2">  </span><span class="si">%(progName)s</span><span class="s2">                               - run default set of tests</span>
<span class="s2">  </span><span class="si">%(progName)s</span><span class="s2"> MyTestSuite                   - run suite &#39;MyTestSuite&#39;</span>
<span class="s2">  </span><span class="si">%(progName)s</span><span class="s2"> MyTestCase.testSomething      - run MyTestCase.testSomething</span>
<span class="s2">  </span><span class="si">%(progName)s</span><span class="s2"> MyTestCase                    - run all &#39;test*&#39; test methods</span>
<span class="s2">                                               in MyTestCase</span>
<span class="s2">&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">module</span><span class="o">=</span><span class="s2">&quot;__main__&quot;</span><span class="p">,</span>
        <span class="n">defaultTest</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">batchmode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">cvg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">outstream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batchmode</span> <span class="o">=</span> <span class="n">batchmode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cvg</span> <span class="o">=</span> <span class="n">cvg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outstream</span> <span class="o">=</span> <span class="n">outstream</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SkipAwareTestProgram</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">module</span><span class="o">=</span><span class="n">module</span><span class="p">,</span> <span class="n">defaultTest</span><span class="o">=</span><span class="n">defaultTest</span><span class="p">,</span> <span class="n">testLoader</span><span class="o">=</span><span class="n">NonStrictTestLoader</span><span class="p">()</span>
        <span class="p">)</span>

<div class="viewcode-block" id="SkipAwareTestProgram.parseArgs"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.SkipAwareTestProgram.parseArgs">[docs]</a>    <span class="k">def</span> <span class="nf">parseArgs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argv</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdbmode</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exitfirst</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skipped_patterns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_pattern</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_pattern</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colorize</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="kn">import</span> <span class="nn">getopt</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">options</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">getopt</span><span class="o">.</span><span class="n">getopt</span><span class="p">(</span>
                <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
                <span class="s2">&quot;hHvixrqcp:s:m:P:&quot;</span><span class="p">,</span>
                <span class="p">[</span>
                    <span class="s2">&quot;help&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;verbose&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;quiet&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;pdb&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;exitfirst&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;restart&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;skip=&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;color&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;match=&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;profile=&quot;</span><span class="p">,</span>
                <span class="p">],</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">opt</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;-h&quot;</span><span class="p">,</span> <span class="s2">&quot;-H&quot;</span><span class="p">,</span> <span class="s2">&quot;--help&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">usageExit</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;-i&quot;</span><span class="p">,</span> <span class="s2">&quot;--pdb&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pdbmode</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;-x&quot;</span><span class="p">,</span> <span class="s2">&quot;--exitfirst&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">exitfirst</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;-r&quot;</span><span class="p">,</span> <span class="s2">&quot;--restart&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">restart</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">exitfirst</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="s2">&quot;--quiet&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="s2">&quot;--verbose&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="k">if</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;-s&quot;</span><span class="p">,</span> <span class="s2">&quot;--skip&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">skipped_patterns</span> <span class="o">=</span> <span class="p">[</span><span class="n">pat</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">opt</span> <span class="o">==</span> <span class="s2">&quot;--color&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">colorize</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="s2">&quot;--match&quot;</span><span class="p">):</span>
                    <span class="c1"># self.tags_pattern = value</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;tag_pattern&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">if</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;-P&quot;</span><span class="p">,</span> <span class="s2">&quot;--profile&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">profile_name</span> <span class="o">=</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">testLoader</span><span class="o">.</span><span class="n">skipped_patterns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skipped_patterns</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaultTest</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">suitefunc</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;suite&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">suitefunc</span><span class="p">,</span> <span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">suite</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testLoader</span><span class="o">.</span><span class="n">loadTestsFromModule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">test_pattern</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">testNames</span> <span class="o">=</span> <span class="n">args</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">testNames</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defaultTest</span><span class="p">,)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">createTests</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">getopt</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">usageExit</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="SkipAwareTestProgram.runTests"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.SkipAwareTestProgram.runTests">[docs]</a>    <span class="k">def</span> <span class="nf">runTests</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_name</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">cProfile</span>

            <span class="n">cProfile</span><span class="o">.</span><span class="n">runctx</span><span class="p">(</span><span class="s2">&quot;self._runTests()&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runTests</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_runTests</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testRunner</span> <span class="o">=</span> <span class="n">SkipAwareTextTestRunner</span><span class="p">(</span>
            <span class="n">verbosity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span><span class="p">,</span>
            <span class="n">stream</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outstream</span><span class="p">,</span>
            <span class="n">exitfirst</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exitfirst</span><span class="p">,</span>
            <span class="n">pdbmode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pdbmode</span><span class="p">,</span>
            <span class="n">cvg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cvg</span><span class="p">,</span>
            <span class="n">test_pattern</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_pattern</span><span class="p">,</span>
            <span class="n">skipped_patterns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">skipped_patterns</span><span class="p">,</span>
            <span class="n">colorize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colorize</span><span class="p">,</span>
            <span class="n">batchmode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batchmode</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">def</span> <span class="nf">removeSucceededTests</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">succTests</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Recursive function that removes succTests from</span>
<span class="sd">            a TestSuite or TestCase</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestSuite</span><span class="p">):</span>
                <span class="n">removeSucceededTests</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_tests</span><span class="p">,</span> <span class="n">succTests</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">[:]:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestSuite</span><span class="p">):</span>
                        <span class="n">removeSucceededTests</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">succTests</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
                        <span class="n">descr</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="n">el</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">el</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">descr</span> <span class="ow">in</span> <span class="n">succTests</span><span class="p">:</span>
                            <span class="n">obj</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>

        <span class="c1"># take care, self.options may be None</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span> <span class="s2">&quot;restart&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="c1"># retrieve succeeded tests from FILE_RESTART</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">restartfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">FILE_RESTART</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">succeededtests</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\r</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">restartfile</span><span class="o">.</span><span class="n">readlines</span><span class="p">())</span>
                    <span class="n">removeSucceededTests</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">succeededtests</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">restartfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;Error while reading succeeded tests into </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">FILE_RESTART</span><span class="p">),</span> <span class="n">ex</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testRunner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="p">)</span>
        <span class="c1"># help garbage collection: we want TestSuite, which hold refs to every</span>
        <span class="c1"># executed TestCase, to be gc&#39;ed</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;debuggers&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;pdbmode&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">start_interactive_mode</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;batchmode&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">wasSuccessful</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">result</span></div>


<div class="viewcode-block" id="SkipAwareTextTestRunner"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.SkipAwareTextTestRunner">[docs]</a><span class="k">class</span> <span class="nc">SkipAwareTextTestRunner</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TextTestRunner</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
        <span class="n">verbosity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">exitfirst</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">pdbmode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">cvg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">test_pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">skipped_patterns</span><span class="o">=</span><span class="p">(),</span>
        <span class="n">colorize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">batchmode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SkipAwareTextTestRunner</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="n">stream</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exitfirst</span> <span class="o">=</span> <span class="n">exitfirst</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdbmode</span> <span class="o">=</span> <span class="n">pdbmode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cvg</span> <span class="o">=</span> <span class="n">cvg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_pattern</span> <span class="o">=</span> <span class="n">test_pattern</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skipped_patterns</span> <span class="o">=</span> <span class="n">skipped_patterns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colorize</span> <span class="o">=</span> <span class="n">colorize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batchmode</span> <span class="o">=</span> <span class="n">batchmode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span>

    <span class="k">def</span> <span class="nf">_this_is_skipped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">testedname</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">([(</span><span class="n">pat</span> <span class="ow">in</span> <span class="n">testedname</span><span class="p">)</span> <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">skipped_patterns</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_runcondition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">skipgenerator</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">testlib</span><span class="o">.</span><span class="n">InnerTest</span><span class="p">):</span>
            <span class="n">testname</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">testlib</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
                <span class="n">meth</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">_get_test_method</span><span class="p">()</span>
                <span class="n">testname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">meth</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">):</span>
                <span class="n">func</span> <span class="o">=</span> <span class="n">test</span>
                <span class="n">testname</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">):</span>
                <span class="bp">cls</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="vm">__self__</span><span class="o">.</span><span class="vm">__class__</span>
                <span class="n">testname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">test</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># Not sure when this happens</span>
            <span class="k">if</span> <span class="n">isgeneratorfunction</span><span class="p">(</span><span class="n">test</span><span class="p">)</span> <span class="ow">and</span> <span class="n">skipgenerator</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">does_match_tags</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>  <span class="c1"># Let inner tests decide at run time</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_this_is_skipped</span><span class="p">(</span><span class="n">testname</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># this was explicitly skipped</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_pattern</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">classpattern</span><span class="p">,</span> <span class="n">testpattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_pattern</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
                <span class="n">klass</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">testname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">classpattern</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">klass</span> <span class="ow">or</span> <span class="n">testpattern</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_pattern</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">testname</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">does_match_tags</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>

<div class="viewcode-block" id="SkipAwareTextTestRunner.does_match_tags"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.SkipAwareTextTestRunner.does_match_tags">[docs]</a>    <span class="k">def</span> <span class="nf">does_match_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tags_pattern</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span> <span class="s2">&quot;tags_pattern&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tags_pattern</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="n">testlib</span><span class="o">.</span><span class="n">Tags</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">tags</span><span class="o">.</span><span class="n">inherit</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">):</span>
                    <span class="n">tags</span> <span class="o">=</span> <span class="n">tags</span> <span class="o">|</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="vm">__self__</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="n">testlib</span><span class="o">.</span><span class="n">Tags</span><span class="p">())</span>
                <span class="k">return</span> <span class="n">tags</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">tags_pattern</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># no pattern</span></div>

    <span class="k">def</span> <span class="nf">_makeResult</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SkipAwareTestResult&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SkipAwareTestResult</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">descriptions</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exitfirst</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pdbmode</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cvg</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">colorize</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="SkipAwareTextTestRunner.run"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.SkipAwareTextTestRunner.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test</span><span class="p">):</span>
        <span class="s2">&quot;Run the given test case or test suite.&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_makeResult</span><span class="p">()</span>
        <span class="n">startTime</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">test</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">runcondition</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_runcondition</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
        <span class="n">stopTime</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">timeTaken</span> <span class="o">=</span> <span class="n">stopTime</span> <span class="o">-</span> <span class="n">startTime</span>
        <span class="n">result</span><span class="o">.</span><span class="n">printErrors</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">batchmode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">writeln</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">separator2</span><span class="p">)</span>
            <span class="n">run</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">testsRun</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">writeln</span><span class="p">(</span><span class="s2">&quot;Ran </span><span class="si">%d</span><span class="s2"> test</span><span class="si">%s</span><span class="s2"> in </span><span class="si">%.3f</span><span class="s2">s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">run</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s2">&quot;s&quot;</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">timeTaken</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">writeln</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">wasSuccessful</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">colorize</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">textutils</span><span class="o">.</span><span class="n">colorize_ansi</span><span class="p">(</span><span class="s2">&quot;FAILED&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;FAILED&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">colorize</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">textutils</span><span class="o">.</span><span class="n">colorize_ansi</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">)</span>
            <span class="n">failed</span><span class="p">,</span> <span class="n">errored</span><span class="p">,</span> <span class="n">skipped</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">failures</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">skipped</span><span class="p">))</span>

            <span class="n">det_results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="p">(</span><span class="s2">&quot;failures&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">failures</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;errors&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">errors</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;skipped&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">skipped</span><span class="p">),</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">det_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">det_results</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; (&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">det_results</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">writeln</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div></div>


<div class="viewcode-block" id="SkipAwareTestResult"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.SkipAwareTestResult">[docs]</a><span class="k">class</span> <span class="nc">SkipAwareTestResult</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">_TextTestResult</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">stream</span><span class="p">:</span> <span class="n">_WritelnDecorator</span><span class="p">,</span>
        <span class="n">descriptions</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">verbosity</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">exitfirst</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">pdbmode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">cvg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">colorize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SkipAwareTestResult</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">descriptions</span><span class="p">,</span> <span class="n">verbosity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skipped</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debuggers</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail_descrs</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_descrs</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exitfirst</span> <span class="o">=</span> <span class="n">exitfirst</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdbmode</span> <span class="o">=</span> <span class="n">pdbmode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cvg</span> <span class="o">=</span> <span class="n">cvg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colorize</span> <span class="o">=</span> <span class="n">colorize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdbclass</span> <span class="o">=</span> <span class="n">Debugger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span>

<div class="viewcode-block" id="SkipAwareTestResult.descrs_for"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.SkipAwareTestResult.descrs_for">[docs]</a>    <span class="k">def</span> <span class="nf">descrs_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flavour</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_descrs&quot;</span> <span class="o">%</span> <span class="n">flavour</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span></div>

    <span class="k">def</span> <span class="nf">_create_pdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_descr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">flavour</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descrs_for</span><span class="p">(</span><span class="n">flavour</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debuggers</span><span class="p">),</span> <span class="n">test_descr</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdbmode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debuggers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdbclass</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">_iter_valid_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frames</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">FrameInfo</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">FrameInfo</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;only consider non-testlib frames when formatting  traceback&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">invalid</span><span class="p">(</span><span class="n">fi</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">osp</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">fi</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">in</span> <span class="p">(</span><span class="n">lgc_testlib</span><span class="p">,</span> <span class="n">std_testlib</span><span class="p">)</span>

        <span class="n">lgc_testlib</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
        <span class="n">std_testlib</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">frameinfo</span> <span class="ow">in</span> <span class="n">dropwhile</span><span class="p">(</span><span class="n">invalid</span><span class="p">,</span> <span class="n">frames</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">frameinfo</span>

    <span class="k">def</span> <span class="nf">_exc_info_to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">test</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts a sys.exc_info()-style tuple of values into a string.</span>

<span class="sd">        This method is overridden here because we want to colorize</span>
<span class="sd">        lines if --color is passed, and display local variables if</span>
<span class="sd">        --verbose is passed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">exctype</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">err</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Traceback (most recent call last)&quot;</span><span class="p">]</span>
        <span class="n">frames</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getinnerframes</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
        <span class="n">colorize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">colorize</span>
        <span class="n">frames</span> <span class="o">=</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iter_valid_frames</span><span class="p">(</span><span class="n">frames</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">funcname</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">ctxindex</span><span class="p">)</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ctx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pyc files or C extensions for instance</span>
                <span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;&lt;no source available&gt;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">colorize</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">textutils</span><span class="o">.</span><span class="n">colorize_ansi</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;magenta&quot;</span><span class="p">)</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">colorize_source</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;  File &quot;</span><span class="si">%s</span><span class="s1">&quot;, line </span><span class="si">%s</span><span class="s1">, in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">funcname</span><span class="p">))</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">source</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> == </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">frame</span><span class="p">),</span> <span class="n">test</span><span class="o">.</span><span class="vm">__module__</span><span class="p">))</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    &quot;</span> <span class="o">+</span> <span class="s2">&quot; local variables &quot;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">66</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">varname</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    </span><span class="si">%s</span><span class="s2">: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">varname</span> <span class="o">==</span> <span class="s2">&quot;self&quot;</span><span class="p">:</span>  <span class="c1"># special handy processing for self</span>
                        <span class="k">for</span> <span class="n">varname</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">vars</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;      self.</span><span class="si">%s</span><span class="s2">: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    &quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">66</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exception_only</span><span class="p">(</span><span class="n">exctype</span><span class="p">,</span> <span class="n">exc</span><span class="p">)))</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

<div class="viewcode-block" id="SkipAwareTestResult.addError"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.SkipAwareTestResult.addError">[docs]</a>    <span class="k">def</span> <span class="nf">addError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">err</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;err -&gt;  (exc_type, exc, tcbk)&quot;&quot;&quot;</span>
        <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">err</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">testlib</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">exc_type</span> <span class="o">==</span> <span class="n">testlib</span><span class="o">.</span><span class="n">SkipTest</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addSkip</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exitfirst</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shouldStop</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">descr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDescription</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">SkipAwareTestResult</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">addError</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_pdb</span><span class="p">(</span><span class="n">descr</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SkipAwareTestResult.addFailure"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.SkipAwareTestResult.addFailure">[docs]</a>    <span class="k">def</span> <span class="nf">addFailure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">err</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exitfirst</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shouldStop</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">descr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDescription</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SkipAwareTestResult</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">addFailure</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_pdb</span><span class="p">(</span><span class="n">descr</span><span class="p">,</span> <span class="s2">&quot;fail&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SkipAwareTestResult.addSkip"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.SkipAwareTestResult.addSkip">[docs]</a>    <span class="k">def</span> <span class="nf">addSkip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skipped</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">test</span><span class="p">,</span> <span class="n">reason</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">showAll</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">writeln</span><span class="p">(</span><span class="s2">&quot;SKIPPED&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dots</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SkipAwareTestResult.printErrors"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.SkipAwareTestResult.printErrors">[docs]</a>    <span class="k">def</span> <span class="nf">printErrors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SkipAwareTestResult</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">printErrors</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">printSkippedList</span><span class="p">()</span></div>

<div class="viewcode-block" id="SkipAwareTestResult.printSkippedList"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.SkipAwareTestResult.printSkippedList">[docs]</a>    <span class="k">def</span> <span class="nf">printSkippedList</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># format (test, err) compatible with unittest2</span>
        <span class="k">for</span> <span class="n">test</span><span class="p">,</span> <span class="n">err</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">skipped</span><span class="p">:</span>
            <span class="n">descr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDescription</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">writeln</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;SKIPPED&quot;</span><span class="p">,</span> <span class="n">descr</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">writeln</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="SkipAwareTestResult.printErrorList"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.SkipAwareTestResult.printErrorList">[docs]</a>    <span class="k">def</span> <span class="nf">printErrorList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flavour</span><span class="p">,</span> <span class="n">errors</span><span class="p">):</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">descr</span><span class="p">),</span> <span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">descrs_for</span><span class="p">(</span><span class="n">flavour</span><span class="p">),</span> <span class="n">errors</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">writeln</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">flavour</span><span class="p">,</span> <span class="n">descr</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">writeln</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">writeln</span><span class="p">(</span><span class="s2">&quot;no stdout&quot;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator2</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">writeln</span><span class="p">(</span><span class="s2">&quot;no stderr&quot;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator2</span><span class="p">)))</span></div></div>


<span class="n">orig_call</span> <span class="o">=</span> <span class="n">testlib</span><span class="o">.</span><span class="n">TestCase</span><span class="o">.</span><span class="fm">__call__</span>


<div class="viewcode-block" id="call"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.call">[docs]</a><span class="nd">@monkeypatch</span><span class="p">(</span><span class="n">testlib</span><span class="o">.</span><span class="n">TestCase</span><span class="p">,</span> <span class="s2">&quot;__call__&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">call</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">result</span><span class="p">:</span> <span class="n">SkipAwareTestResult</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">runcondition</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">orig_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">,</span> <span class="n">runcondition</span><span class="o">=</span><span class="n">runcondition</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
    <span class="c1"># mypy: Item &quot;None&quot; of &quot;Optional[Any]&quot; has no attribute &quot;exitfirst&quot;</span>
    <span class="c1"># we check it first in the if</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="s2">&quot;exitfirst&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">options</span><span class="o">.</span><span class="n">exitfirst</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
        <span class="c1"># add this test to restart file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">restartfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">FILE_RESTART</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">descr</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">restartfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">descr</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">restartfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Error while saving succeeded test into&quot;</span><span class="p">,</span>
                <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">FILE_RESTART</span><span class="p">),</span>
                <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">__stderr__</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="defaultTestResult"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.defaultTestResult">[docs]</a><span class="nd">@monkeypatch</span><span class="p">(</span><span class="n">testlib</span><span class="o">.</span><span class="n">TestCase</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">defaultTestResult</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;return a new instance of the defaultTestResult&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">SkipAwareTestResult</span><span class="p">()</span></div>


<div class="viewcode-block" id="NonStrictTestLoader"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.NonStrictTestLoader">[docs]</a><span class="k">class</span> <span class="nc">NonStrictTestLoader</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestLoader</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Overrides default testloader to be able to omit classname when</span>
<span class="sd">    specifying tests to run on command line.</span>

<span class="sd">    For example, if the file test_foo.py contains ::</span>

<span class="sd">        class FooTC(TestCase):</span>
<span class="sd">            def test_foo1(self): # ...</span>
<span class="sd">            def test_foo2(self): # ...</span>
<span class="sd">            def test_bar1(self): # ...</span>

<span class="sd">        class BarTC(TestCase):</span>
<span class="sd">            def test_bar2(self): # ...</span>

<span class="sd">    &#39;python test_foo.py&#39; will run the 3 tests in FooTC</span>
<span class="sd">    &#39;python test_foo.py FooTC&#39; will run the 3 tests in FooTC</span>
<span class="sd">    &#39;python test_foo.py test_foo&#39; will run test_foo1 and test_foo2</span>
<span class="sd">    &#39;python test_foo.py test_foo1&#39; will run test_foo1</span>
<span class="sd">    &#39;python test_foo.py test_bar&#39; will run FooTC.test_bar1 and BarTC.test_bar2</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skipped_patterns</span> <span class="o">=</span> <span class="p">()</span>

    <span class="c1"># some magic here to accept empty list by extending</span>
    <span class="c1"># and to provide callable capability</span>
<div class="viewcode-block" id="NonStrictTestLoader.loadTestsFromNames"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.NonStrictTestLoader.loadTestsFromNames">[docs]</a>    <span class="k">def</span> <span class="nf">loadTestsFromNames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">module</span><span class="p">:</span> <span class="nb">type</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TestSuite</span><span class="p">:</span>
        <span class="n">suites</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">suites</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loadTestsFromName</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">module</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">suiteClass</span><span class="p">(</span><span class="n">suites</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_collect_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">:</span> <span class="nb">type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">type</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]:</span>
        <span class="n">tests</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="n">module</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">isclass</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
                <span class="n">classname</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="k">if</span> <span class="n">classname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;_&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_this_is_skipped</span><span class="p">(</span><span class="n">classname</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">methodnames</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># obj is a TestCase class</span>
                <span class="k">for</span> <span class="n">attrname</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">attrname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testMethodPrefix</span><span class="p">):</span>
                        <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attrname</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
                            <span class="n">methodnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attrname</span><span class="p">)</span>
                <span class="c1"># keep track of class (obj) for convenience</span>
                <span class="n">tests</span><span class="p">[</span><span class="n">classname</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">methodnames</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tests</span>

<div class="viewcode-block" id="NonStrictTestLoader.loadTestsFromSuite"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.NonStrictTestLoader.loadTestsFromSuite">[docs]</a>    <span class="k">def</span> <span class="nf">loadTestsFromSuite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">suitename</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">suite</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">suitename</span><span class="p">)()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">suite</span><span class="p">,</span> <span class="s2">&quot;_tests&quot;</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2"> is not a valid TestSuite&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">module</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">suitename</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># python2.3 does not implement __iter__ on suites, we need to return</span>
        <span class="c1"># _tests explicitly</span>
        <span class="k">return</span> <span class="n">suite</span><span class="o">.</span><span class="n">_tests</span></div>

<div class="viewcode-block" id="NonStrictTestLoader.loadTestsFromName"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.NonStrictTestLoader.loadTestsFromName">[docs]</a>    <span class="k">def</span> <span class="nf">loadTestsFromName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">module</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># let the base class do its job here</span>
            <span class="k">return</span> <span class="p">[</span><span class="nb">super</span><span class="p">(</span><span class="n">NonStrictTestLoader</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">loadTestsFromName</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span>
        <span class="n">tests</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_tests</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
        <span class="n">collected</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span> <span class="ow">and</span> <span class="n">pattern</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tests</span><span class="p">:</span>
                <span class="c1"># consider it as a suite</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadTestsFromSuite</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">tests</span><span class="p">:</span>
                <span class="c1"># case python unittest_foo.py MyTestTC</span>
                <span class="n">klass</span><span class="p">,</span> <span class="n">methodnames</span> <span class="o">=</span> <span class="n">tests</span><span class="p">[</span><span class="n">pattern</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">methodname</span> <span class="ow">in</span> <span class="n">methodnames</span><span class="p">:</span>
                    <span class="n">collected</span> <span class="o">=</span> <span class="p">[</span><span class="n">klass</span><span class="p">(</span><span class="n">methodname</span><span class="p">)</span> <span class="k">for</span> <span class="n">methodname</span> <span class="ow">in</span> <span class="n">methodnames</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># case python unittest_foo.py something</span>
                <span class="k">for</span> <span class="n">klass</span><span class="p">,</span> <span class="n">methodnames</span> <span class="ow">in</span> <span class="n">tests</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="c1"># skip methodname if matched by skipped_patterns</span>
                    <span class="k">for</span> <span class="n">skip_pattern</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">skipped_patterns</span><span class="p">:</span>
                        <span class="n">methodnames</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">methodname</span>
                            <span class="k">for</span> <span class="n">methodname</span> <span class="ow">in</span> <span class="n">methodnames</span>
                            <span class="k">if</span> <span class="n">skip_pattern</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">methodname</span>
                        <span class="p">]</span>
                    <span class="n">collected</span> <span class="o">+=</span> <span class="p">[</span>
                        <span class="n">klass</span><span class="p">(</span><span class="n">methodname</span><span class="p">)</span> <span class="k">for</span> <span class="n">methodname</span> <span class="ow">in</span> <span class="n">methodnames</span> <span class="k">if</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">methodname</span>
                    <span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># case &quot;MyClass.test_1&quot;</span>
            <span class="n">classname</span><span class="p">,</span> <span class="n">pattern</span> <span class="o">=</span> <span class="n">parts</span>
            <span class="n">klass</span><span class="p">,</span> <span class="n">methodnames</span> <span class="o">=</span> <span class="n">tests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">classname</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">for</span> <span class="n">methodname</span> <span class="ow">in</span> <span class="n">methodnames</span><span class="p">:</span>
                <span class="n">collected</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">klass</span><span class="p">(</span><span class="n">methodname</span><span class="p">)</span> <span class="k">for</span> <span class="n">methodname</span> <span class="ow">in</span> <span class="n">methodnames</span> <span class="k">if</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">methodname</span>
                <span class="p">]</span>
        <span class="k">return</span> <span class="n">collected</span></div>

    <span class="k">def</span> <span class="nf">_this_is_skipped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">testedname</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="c1"># mypy: Need type annotation for &#39;pat&#39;</span>
        <span class="c1"># doc doesn&#39;t say how to that in list comprehension</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">([(</span><span class="n">pat</span> <span class="ow">in</span> <span class="n">testedname</span><span class="p">)</span> <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">skipped_patterns</span><span class="p">])</span>  <span class="c1"># type: ignore</span>

<div class="viewcode-block" id="NonStrictTestLoader.getTestCaseNames"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.NonStrictTestLoader.getTestCaseNames">[docs]</a>    <span class="k">def</span> <span class="nf">getTestCaseNames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">testCaseClass</span><span class="p">:</span> <span class="nb">type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return a sorted sequence of method names found within testCaseClass&quot;&quot;&quot;</span>
        <span class="n">is_skipped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_this_is_skipped</span>
        <span class="n">classname</span> <span class="o">=</span> <span class="n">testCaseClass</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">if</span> <span class="n">classname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;_&quot;</span> <span class="ow">or</span> <span class="n">is_skipped</span><span class="p">(</span><span class="n">classname</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">testnames</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">NonStrictTestLoader</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">getTestCaseNames</span><span class="p">(</span><span class="n">testCaseClass</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">testname</span> <span class="k">for</span> <span class="n">testname</span> <span class="ow">in</span> <span class="n">testnames</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">is_skipped</span><span class="p">(</span><span class="n">testname</span><span class="p">)]</span></div></div>


<span class="c1"># The 2 functions below are modified versions of the TestSuite.run method</span>
<span class="c1"># that is provided with unittest2 for python 2.6, in unittest2/suite.py</span>
<span class="c1"># It is used to monkeypatch the original implementation to support</span>
<span class="c1"># extra runcondition and options arguments (see in testlib.py)</span>


<span class="k">def</span> <span class="nf">_ts_run</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">result</span><span class="p">:</span> <span class="n">SkipAwareTestResult</span><span class="p">,</span>
    <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">runcondition</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SkipAwareTestResult</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_wrapped_run</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">runcondition</span><span class="o">=</span><span class="n">runcondition</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_tearDownPreviousClass</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_handleModuleTearDown</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">_ts_wrapped_run</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">result</span><span class="p">:</span> <span class="n">SkipAwareTestResult</span><span class="p">,</span>
    <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">runcondition</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SkipAwareTestResult</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">shouldStop</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">unittest_suite</span><span class="o">.</span><span class="n">_isnotsuite</span><span class="p">(</span><span class="n">test</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tearDownPreviousClass</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handleModuleFixture</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handleClassSetUp</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">_previousTestClass</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="vm">__class__</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="s2">&quot;_classSetupFailed&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span>
                <span class="n">result</span><span class="p">,</span> <span class="s2">&quot;_moduleSetUpFailed&quot;</span><span class="p">,</span> <span class="kc">False</span>
            <span class="p">):</span>
                <span class="k">continue</span>

        <span class="c1"># --- modifications to deal with _wrapped_run ---</span>
        <span class="c1"># original code is:</span>
        <span class="c1">#</span>
        <span class="c1"># if not debug:</span>
        <span class="c1">#     test(result)</span>
        <span class="c1"># else:</span>
        <span class="c1">#     test.debug()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="s2">&quot;_wrapped_run&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">test</span><span class="o">.</span><span class="n">_wrapped_run</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">runcondition</span><span class="o">=</span><span class="n">runcondition</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">test</span><span class="o">.</span><span class="n">_wrapped_run</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">debug</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">test</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">runcondition</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">test</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">test</span><span class="o">.</span><span class="n">debug</span><span class="p">()</span>
        <span class="c1"># --- end of modifications to deal with _wrapped_run ---</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
    <span class="c1"># The function below implements a modified version of the</span>
    <span class="c1"># TestSuite.run method that is provided with python 2.7, in</span>
    <span class="c1"># unittest/suite.py</span>
    <span class="k">def</span> <span class="nf">_ts_run</span><span class="p">(</span>  <span class="c1"># noqa</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">result</span><span class="p">:</span> <span class="n">SkipAwareTestResult</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">runcondition</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SkipAwareTestResult</span><span class="p">:</span>
        <span class="n">topLevel</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;_testRunEntered&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">_testRunEntered</span> <span class="o">=</span> <span class="n">topLevel</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_wrapped_run</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">runcondition</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">topLevel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tearDownPreviousClass</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handleModuleTearDown</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">_testRunEntered</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">result</span>


<div class="viewcode-block" id="enable_dbc"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.pytest.enable_dbc">[docs]</a><span class="k">def</span> <span class="nf">enable_dbc</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Without arguments, return True if contracts can be enabled and should be</span>
<span class="sd">    enabled (see option -d), return False otherwise.</span>

<span class="sd">    With arguments, return False if contracts can&#39;t or shouldn&#39;t be enabled,</span>
<span class="sd">    otherwise weave ContractAspect with items passed as arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ENABLE_DBC</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">logilab.aspects.weaver</span> <span class="kn">import</span> <span class="n">weaver</span>
        <span class="kn">from</span> <span class="nn">logilab.aspects.lib.contracts</span> <span class="kn">import</span> <span class="n">ContractAspect</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Warning: logilab.aspects is not available. Contracts disabled.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">weaver</span><span class="o">.</span><span class="n">weave_module</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">ContractAspect</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<span class="c1"># monkeypatch unittest and doctest (ouch !)</span>
<span class="n">unittest</span><span class="o">.</span><span class="n">_TextTestResult</span> <span class="o">=</span> <span class="n">SkipAwareTestResult</span>
<span class="n">unittest</span><span class="o">.</span><span class="n">TextTestRunner</span> <span class="o">=</span> <span class="n">SkipAwareTextTestRunner</span>
<span class="n">unittest</span><span class="o">.</span><span class="n">TestLoader</span> <span class="o">=</span> <span class="n">NonStrictTestLoader</span>
<span class="n">unittest</span><span class="o">.</span><span class="n">TestProgram</span> <span class="o">=</span> <span class="n">SkipAwareTestProgram</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
    <span class="n">doctest</span><span class="o">.</span><span class="n">DocTestCase</span><span class="o">.</span><span class="vm">__bases__</span> <span class="o">=</span> <span class="p">(</span><span class="n">testlib</span><span class="o">.</span><span class="n">TestCase</span><span class="p">,)</span>
    <span class="c1"># XXX check python2.6 compatibility</span>
    <span class="c1"># doctest.DocTestCase._cleanups = []</span>
    <span class="c1"># doctest.DocTestCase._out = []</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">unittest</span><span class="o">.</span><span class="n">FunctionTestCase</span><span class="o">.</span><span class="vm">__bases__</span> <span class="o">=</span> <span class="p">(</span><span class="n">testlib</span><span class="o">.</span><span class="n">TestCase</span><span class="p">,)</span>
<span class="n">unittest</span><span class="o">.</span><span class="n">TestSuite</span><span class="o">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">_ts_run</span>
<span class="n">unittest</span><span class="o">.</span><span class="n">TestSuite</span><span class="o">.</span><span class="n">_wrapped_run</span> <span class="o">=</span> <span class="n">_ts_wrapped_run</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">run</span><span class="p">()</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">logilab common</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../logilab.common.html">logilab.common package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../logilab.common.ureports.html">logilab.common.ureports package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  <li><a href="../common.html">logilab.common</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Logilab.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>