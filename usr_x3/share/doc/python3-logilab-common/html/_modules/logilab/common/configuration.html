
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>logilab.common.configuration &#8212; logilab common  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for logilab.common.configuration</h1><div class="highlight"><pre>
<span></span><span class="c1"># copyright 2003-2012 LOGILAB S.A. (Paris, FRANCE), all rights reserved.</span>
<span class="c1"># contact http://www.logilab.fr/ -- mailto:contact@logilab.fr</span>
<span class="c1">#</span>
<span class="c1"># This file is part of logilab-common.</span>
<span class="c1">#</span>
<span class="c1"># logilab-common is free software: you can redistribute it and/or modify it under</span>
<span class="c1"># the terms of the GNU Lesser General Public License as published by the Free</span>
<span class="c1"># Software Foundation, either version 2.1 of the License, or (at your option) any</span>
<span class="c1"># later version.</span>
<span class="c1">#</span>
<span class="c1"># logilab-common is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="c1"># ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
<span class="c1"># FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public License for more</span>
<span class="c1"># details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU Lesser General Public License along</span>
<span class="c1"># with logilab-common.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="sd">&quot;&quot;&quot;Classes to handle advanced configuration in simple to complex applications.</span>

<span class="sd">Allows to load the configuration from a file or from command line</span>
<span class="sd">options, to generate a sample configuration file or to display</span>
<span class="sd">program&#39;s usage. Fills the gap between optik/optparse and ConfigParser</span>
<span class="sd">by adding data types (which are also available as a standalone optik</span>
<span class="sd">extension in the `optik_ext` module).</span>


<span class="sd">Quick start: simplest usage</span>
<span class="sd">---------------------------</span>

<span class="sd">.. ::</span>

<span class="sd">  &gt;&gt;&gt; import sys</span>
<span class="sd">  &gt;&gt;&gt; from logilab.common.configuration import Configuration</span>
<span class="sd">  &gt;&gt;&gt; options = [(&#39;dothis&#39;, {&#39;type&#39;:&#39;yn&#39;, &#39;default&#39;: True, &#39;metavar&#39;: &#39;&lt;y or n&gt;&#39;}),</span>
<span class="sd">  ...            (&#39;value&#39;, {&#39;type&#39;: &#39;string&#39;, &#39;metavar&#39;: &#39;&lt;string&gt;&#39;}),</span>
<span class="sd">  ...            (&#39;multiple&#39;, {&#39;type&#39;: &#39;csv&#39;, &#39;default&#39;: (&#39;yop&#39;,),</span>
<span class="sd">  ...                          &#39;metavar&#39;: &#39;&lt;comma separated values&gt;&#39;,</span>
<span class="sd">  ...                          &#39;help&#39;: &#39;you can also document the option&#39;}),</span>
<span class="sd">  ...            (&#39;number&#39;, {&#39;type&#39;: &#39;int&#39;, &#39;default&#39;:2, &#39;metavar&#39;:&#39;&lt;int&gt;&#39;}),</span>
<span class="sd">  ...           ]</span>
<span class="sd">  &gt;&gt;&gt; config = Configuration(options=options, name=&#39;My config&#39;)</span>
<span class="sd">  &gt;&gt;&gt; print config[&#39;dothis&#39;]</span>
<span class="sd">  True</span>
<span class="sd">  &gt;&gt;&gt; print config[&#39;value&#39;]</span>
<span class="sd">  None</span>
<span class="sd">  &gt;&gt;&gt; print config[&#39;multiple&#39;]</span>
<span class="sd">  (&#39;yop&#39;,)</span>
<span class="sd">  &gt;&gt;&gt; print config[&#39;number&#39;]</span>
<span class="sd">  2</span>
<span class="sd">  &gt;&gt;&gt; print config.help()</span>
<span class="sd">  Usage:  [options]</span>

<span class="sd">  Options:</span>
<span class="sd">    -h, --help            show this help message and exit</span>
<span class="sd">    --dothis=&lt;y or n&gt;</span>
<span class="sd">    --value=&lt;string&gt;</span>
<span class="sd">    --multiple=&lt;comma separated values&gt;</span>
<span class="sd">                          you can also document the option [current: none]</span>
<span class="sd">    --number=&lt;int&gt;</span>

<span class="sd">  &gt;&gt;&gt; f = open(&#39;myconfig.ini&#39;, &#39;w&#39;)</span>
<span class="sd">  &gt;&gt;&gt; f.write(&#39;&#39;&#39;[MY CONFIG]</span>
<span class="sd">  ... number = 3</span>
<span class="sd">  ... dothis = no</span>
<span class="sd">  ... multiple = 1,2,3</span>
<span class="sd">  ... &#39;&#39;&#39;)</span>
<span class="sd">  &gt;&gt;&gt; f.close()</span>
<span class="sd">  &gt;&gt;&gt; config.load_file_configuration(&#39;myconfig.ini&#39;)</span>
<span class="sd">  &gt;&gt;&gt; print config[&#39;dothis&#39;]</span>
<span class="sd">  False</span>
<span class="sd">  &gt;&gt;&gt; print config[&#39;value&#39;]</span>
<span class="sd">  None</span>
<span class="sd">  &gt;&gt;&gt; print config[&#39;multiple&#39;]</span>
<span class="sd">  [&#39;1&#39;, &#39;2&#39;, &#39;3&#39;]</span>
<span class="sd">  &gt;&gt;&gt; print config[&#39;number&#39;]</span>
<span class="sd">  3</span>
<span class="sd">  &gt;&gt;&gt; sys.argv = [&#39;mon prog&#39;, &#39;--value&#39;, &#39;bacon&#39;, &#39;--multiple&#39;, &#39;4,5,6&#39;,</span>
<span class="sd">  ...             &#39;nonoptionargument&#39;]</span>
<span class="sd">  &gt;&gt;&gt; print config.load_command_line_configuration()</span>
<span class="sd">  [&#39;nonoptionargument&#39;]</span>
<span class="sd">  &gt;&gt;&gt; print config[&#39;value&#39;]</span>
<span class="sd">  bacon</span>
<span class="sd">  &gt;&gt;&gt; config.generate_config()</span>
<span class="sd">  # class for simple configurations which don&#39;t need the</span>
<span class="sd">  # manager / providers model and prefer delegation to inheritance</span>
<span class="sd">  #</span>
<span class="sd">  # configuration values are accessible through a dict like interface</span>
<span class="sd">  #</span>
<span class="sd">  [MY CONFIG]</span>

<span class="sd">  dothis=no</span>

<span class="sd">  value=bacon</span>

<span class="sd">  # you can also document the option</span>
<span class="sd">  multiple=4,5,6</span>

<span class="sd">  number=3</span>

<span class="sd">  Note : starting with Python 2.7 ConfigParser is able to take into</span>
<span class="sd">  account the order of occurrences of the options into a file (by</span>
<span class="sd">  using an OrderedDict). If you have two options changing some common</span>
<span class="sd">  state, like a &#39;disable-all-stuff&#39; and a &#39;enable-some-stuff-a&#39;, their</span>
<span class="sd">  order of appearance will be significant : the last specified in the</span>
<span class="sd">  file wins. For earlier version of python and logilab.common newer</span>
<span class="sd">  than 0.61 the behaviour is unspecified.</span>

<span class="sd">&quot;&quot;&quot;</span>


<span class="n">__docformat__</span> <span class="o">=</span> <span class="s2">&quot;restructuredtext en&quot;</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;OptionsManagerMixIn&quot;</span><span class="p">,</span>
    <span class="s2">&quot;OptionsProviderMixIn&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ConfigurationMixIn&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Configuration&quot;</span><span class="p">,</span>
    <span class="s2">&quot;OptionsManager2ConfigurationAdapter&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">difflib</span> <span class="kn">import</span> <span class="n">get_close_matches</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">exists</span><span class="p">,</span> <span class="n">expanduser</span>
<span class="kn">from</span> <span class="nn">optparse</span> <span class="kn">import</span> <span class="n">OptionGroup</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
<span class="kn">from</span> <span class="nn">_io</span> <span class="kn">import</span> <span class="n">StringIO</span><span class="p">,</span> <span class="n">TextIOWrapper</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">Callable</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>

<span class="kn">import</span> <span class="nn">configparser</span> <span class="k">as</span> <span class="nn">cp</span>

<span class="kn">from</span> <span class="nn">logilab.common.types</span> <span class="kn">import</span> <span class="n">OptionParser</span><span class="p">,</span> <span class="n">Option</span><span class="p">,</span> <span class="n">attrdict</span>
<span class="kn">from</span> <span class="nn">logilab.common.compat</span> <span class="kn">import</span> <span class="n">str_encode</span> <span class="k">as</span> <span class="n">_encode</span>
<span class="kn">from</span> <span class="nn">logilab.common.deprecation</span> <span class="kn">import</span> <span class="n">callable_deprecated</span>
<span class="kn">from</span> <span class="nn">logilab.common.textutils</span> <span class="kn">import</span> <span class="n">normalize_text</span><span class="p">,</span> <span class="n">unquote</span>
<span class="kn">from</span> <span class="nn">logilab.common</span> <span class="kn">import</span> <span class="n">optik_ext</span>


<span class="n">OptionError</span> <span class="o">=</span> <span class="n">optik_ext</span><span class="o">.</span><span class="n">OptionError</span>

<span class="n">REQUIRED</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="p">[]</span>


<span class="k">class</span> <span class="nc">UnsupportedAction</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;raised by set_option when it doesn&#39;t know what to do for an action&quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">_get_encoding</span><span class="p">(</span><span class="n">encoding</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">stream</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">StringIO</span><span class="p">,</span> <span class="n">TextIOWrapper</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">encoding</span> <span class="o">=</span> <span class="n">encoding</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s2">&quot;encoding&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">encoding</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">locale</span>

        <span class="n">encoding</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">getpreferredencoding</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">encoding</span>


<span class="n">_ValueType</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span>

<span class="c1"># validation functions ########################################################</span>

<span class="c1"># validators will return the validated value or raise optparse.OptionValueError</span>
<span class="c1"># XXX add to documentation</span>


<span class="k">def</span> <span class="nf">choice_validator</span><span class="p">(</span><span class="n">optdict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;validate and return a converted value for option of type &#39;choice&#39;&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">optdict</span><span class="p">[</span><span class="s2">&quot;choices&quot;</span><span class="p">]:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;option </span><span class="si">%s</span><span class="s2">: invalid value: </span><span class="si">%r</span><span class="s2">, should be in </span><span class="si">%s</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="n">optik_ext</span><span class="o">.</span><span class="n">OptionValueError</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">optdict</span><span class="p">[</span><span class="s2">&quot;choices&quot;</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">value</span>


<span class="k">def</span> <span class="nf">multiple_choice_validator</span><span class="p">(</span><span class="n">optdict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_ValueType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_ValueType</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;validate and return a converted value for option of type &#39;choice&#39;&quot;&quot;&quot;</span>
    <span class="n">choices</span> <span class="o">=</span> <span class="n">optdict</span><span class="p">[</span><span class="s2">&quot;choices&quot;</span><span class="p">]</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">optik_ext</span><span class="o">.</span><span class="n">check_csv</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">choices</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;option </span><span class="si">%s</span><span class="s2">: invalid value: </span><span class="si">%r</span><span class="s2">, should be in </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="n">optik_ext</span><span class="o">.</span><span class="n">OptionValueError</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">choices</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">values</span>


<span class="k">def</span> <span class="nf">csv_validator</span><span class="p">(</span><span class="n">optdict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_ValueType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_ValueType</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;validate and return a converted value for option of type &#39;csv&#39;&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">optik_ext</span><span class="o">.</span><span class="n">check_csv</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">yn_validator</span><span class="p">(</span><span class="n">optdict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;validate and return a converted value for option of type &#39;yn&#39;&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">optik_ext</span><span class="o">.</span><span class="n">check_yn</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">named_validator</span><span class="p">(</span>
    <span class="n">optdict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;validate and return a converted value for option of type &#39;named&#39;&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">optik_ext</span><span class="o">.</span><span class="n">check_named</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">file_validator</span><span class="p">(</span><span class="n">optdict</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;validate and return a filepath for option of type &#39;file&#39;&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">optik_ext</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">color_validator</span><span class="p">(</span><span class="n">optdict</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;validate and return a valid color for option of type &#39;color&#39;&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">optik_ext</span><span class="o">.</span><span class="n">check_color</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">password_validator</span><span class="p">(</span><span class="n">optdict</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;validate and return a string for option of type &#39;password&#39;&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">optik_ext</span><span class="o">.</span><span class="n">check_password</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">date_validator</span><span class="p">(</span><span class="n">optdict</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;validate and return a mx DateTime object for option of type &#39;date&#39;&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">optik_ext</span><span class="o">.</span><span class="n">check_date</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">time_validator</span><span class="p">(</span><span class="n">optdict</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;validate and return a time object for option of type &#39;time&#39;&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">optik_ext</span><span class="o">.</span><span class="n">check_time</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">bytes_validator</span><span class="p">(</span><span class="n">optdict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;validate and return an integer for option of type &#39;bytes&#39;&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">optik_ext</span><span class="o">.</span><span class="n">check_bytes</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="n">VALIDATORS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;string&quot;</span><span class="p">:</span> <span class="n">unquote</span><span class="p">,</span>
    <span class="s2">&quot;int&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="s2">&quot;float&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">file_validator</span><span class="p">,</span>
    <span class="s2">&quot;font&quot;</span><span class="p">:</span> <span class="n">unquote</span><span class="p">,</span>
    <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">color_validator</span><span class="p">,</span>
    <span class="s2">&quot;regexp&quot;</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">,</span>
    <span class="s2">&quot;csv&quot;</span><span class="p">:</span> <span class="n">csv_validator</span><span class="p">,</span>
    <span class="s2">&quot;yn&quot;</span><span class="p">:</span> <span class="n">yn_validator</span><span class="p">,</span>
    <span class="s2">&quot;bool&quot;</span><span class="p">:</span> <span class="n">yn_validator</span><span class="p">,</span>
    <span class="s2">&quot;named&quot;</span><span class="p">:</span> <span class="n">named_validator</span><span class="p">,</span>
    <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">password_validator</span><span class="p">,</span>
    <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">date_validator</span><span class="p">,</span>
    <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">time_validator</span><span class="p">,</span>
    <span class="s2">&quot;bytes&quot;</span><span class="p">:</span> <span class="n">bytes_validator</span><span class="p">,</span>
    <span class="s2">&quot;choice&quot;</span><span class="p">:</span> <span class="n">choice_validator</span><span class="p">,</span>
    <span class="s2">&quot;multiple_choice&quot;</span><span class="p">:</span> <span class="n">multiple_choice_validator</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">_call_validator</span><span class="p">(</span>
    <span class="n">opttype</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">optdict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">option</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">opttype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">VALIDATORS</span><span class="p">:</span>
        <span class="n">all_validators</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> - &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">VALIDATORS</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unsupported type &quot;</span><span class="si">{</span><span class="n">opttype</span><span class="si">}</span><span class="s1">&quot;, supported types are:</span><span class="se">\n</span><span class="s1"> - </span><span class="si">{</span><span class="n">all_validators</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">VALIDATORS</span><span class="p">[</span><span class="n">opttype</span><span class="p">](</span><span class="n">optdict</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">VALIDATORS</span><span class="p">[</span><span class="n">opttype</span><span class="p">](</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">optik_ext</span><span class="o">.</span><span class="n">OptionValueError</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">optik_ext</span><span class="o">.</span><span class="n">OptionValueError</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> value (</span><span class="si">%r</span><span class="s2">) should be of type </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">opttype</span><span class="p">)</span>
            <span class="p">)</span>


<span class="c1"># user input functions ########################################################</span>

<span class="c1"># user input functions will ask the user for input on stdin then validate</span>
<span class="c1"># the result and return the validated value or raise optparse.OptionValueError</span>
<span class="c1"># XXX add to documentation</span>


<span class="k">def</span> <span class="nf">input_password</span><span class="p">(</span><span class="n">optdict</span><span class="p">,</span> <span class="n">question</span><span class="o">=</span><span class="s2">&quot;password:&quot;</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">getpass</span> <span class="kn">import</span> <span class="n">getpass</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">getpass</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
        <span class="n">value2</span> <span class="o">=</span> <span class="n">getpass</span><span class="p">(</span><span class="s2">&quot;confirm: &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">value2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;password mismatch, try again&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">input_string</span><span class="p">(</span><span class="n">optdict</span><span class="p">,</span> <span class="n">question</span><span class="p">):</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">question</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">value</span> <span class="ow">or</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_make_input_function</span><span class="p">(</span><span class="n">opttype</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">input_validator</span><span class="p">(</span><span class="n">optdict</span><span class="p">,</span> <span class="n">question</span><span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">_call_validator</span><span class="p">(</span><span class="n">opttype</span><span class="p">,</span> <span class="n">optdict</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">optik_ext</span><span class="o">.</span><span class="n">OptionValueError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;bad value: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">input_validator</span>


<span class="n">INPUT_FUNCTIONS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;string&quot;</span><span class="p">:</span> <span class="n">input_string</span><span class="p">,</span>
    <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">input_password</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">for</span> <span class="n">opttype</span> <span class="ow">in</span> <span class="n">VALIDATORS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">INPUT_FUNCTIONS</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">opttype</span><span class="p">,</span> <span class="n">_make_input_function</span><span class="p">(</span><span class="n">opttype</span><span class="p">))</span>

<span class="c1"># utility functions ############################################################</span>


<span class="k">def</span> <span class="nf">expand_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;monkey patch OptionParser.expand_default since we have a particular</span>
<span class="sd">    way to handle defaults to avoid overriding values in the configuration</span>
<span class="sd">    file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_tag</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">option</span><span class="o">.</span><span class="n">help</span>
    <span class="n">optname</span> <span class="o">=</span> <span class="n">option</span><span class="o">.</span><span class="n">_long_opts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">:]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">options_manager</span><span class="o">.</span><span class="n">_all_options</span><span class="p">[</span><span class="n">optname</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">optdict</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">get_option_def</span><span class="p">(</span><span class="n">optname</span><span class="p">)</span>
        <span class="n">optname</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">option_attrname</span><span class="p">(</span><span class="n">optname</span><span class="p">,</span> <span class="n">optdict</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">optname</span><span class="p">,</span> <span class="n">optdict</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">format_option_value</span><span class="p">(</span><span class="n">optdict</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">optik_ext</span><span class="o">.</span><span class="n">NO_DEFAULT</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NO_DEFAULT_VALUE</span>
    <span class="k">return</span> <span class="n">option</span><span class="o">.</span><span class="n">help</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_tag</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span>
    <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">optdict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;return a validated value for an option according to its type</span>

<span class="sd">    optional argument name is only used for error message formatting</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_type</span> <span class="o">=</span> <span class="n">optdict</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="c1"># FIXME</span>
        <span class="k">return</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">_call_validator</span><span class="p">(</span><span class="n">_type</span><span class="p">,</span> <span class="n">optdict</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="n">convert</span> <span class="o">=</span> <span class="n">callable_deprecated</span><span class="p">(</span><span class="s2">&quot;[0.60] convert() was renamed _validate()&quot;</span><span class="p">)(</span><span class="n">_validate</span><span class="p">)</span>

<span class="c1"># format and output functions ##################################################</span>


<span class="k">def</span> <span class="nf">comment</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;return string as a comment&quot;&quot;&quot;</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()]</span>
    <span class="k">return</span> <span class="s2">&quot;# &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"># &quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">format_time</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;0&quot;</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">s&quot;</span> <span class="o">%</span> <span class="n">value</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">nbmin</span><span class="p">,</span> <span class="n">nbsec</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nbsec</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">s&quot;</span> <span class="o">%</span> <span class="n">value</span>
    <span class="n">nbhour</span><span class="p">,</span> <span class="n">nbmin_</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">nbmin</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nbmin_</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">min&quot;</span> <span class="o">%</span> <span class="n">nbmin</span>
    <span class="n">nbday</span><span class="p">,</span> <span class="n">nbhour_</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">nbhour</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nbhour_</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">h&quot;</span> <span class="o">%</span> <span class="n">nbhour</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">d&quot;</span> <span class="o">%</span> <span class="n">nbday</span>


<span class="k">def</span> <span class="nf">format_bytes</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;0&quot;</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">B&quot;</span> <span class="o">%</span> <span class="n">value</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">prevunit</span> <span class="o">=</span> <span class="s2">&quot;B&quot;</span>
    <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;KB&quot;</span><span class="p">,</span> <span class="s2">&quot;MB&quot;</span><span class="p">,</span> <span class="s2">&quot;GB&quot;</span><span class="p">,</span> <span class="s2">&quot;TB&quot;</span><span class="p">):</span>
        <span class="nb">next</span><span class="p">,</span> <span class="n">remain</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remain</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">prevunit</span><span class="p">)</span>
        <span class="n">prevunit</span> <span class="o">=</span> <span class="n">unit</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">next</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">format_option_value</span><span class="p">(</span><span class="n">optdict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;return the user input&#39;s value from a &#39;compiled&#39; value&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;match&quot;</span><span class="p">):</span>  <span class="c1"># optdict.get(&#39;type&#39;) == &#39;regexp&#39;</span>
        <span class="c1"># compiled regexp</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">pattern</span>
    <span class="k">elif</span> <span class="n">optdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;yn&quot;</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span> <span class="ow">and</span> <span class="s2">&quot;yes&quot;</span> <span class="ow">or</span> <span class="s2">&quot;no&quot;</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">value</span>
    <span class="k">elif</span> <span class="n">optdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;time&quot;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">format_time</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">optdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;bytes&quot;</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;__int__&quot;</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">format_bytes</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>


<span class="k">def</span> <span class="nf">ini_format_section</span><span class="p">(</span>
    <span class="n">stream</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">StringIO</span><span class="p">,</span> <span class="n">TextIOWrapper</span><span class="p">],</span>
    <span class="n">section</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">options</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">doc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;format an options section using the INI format&quot;&quot;&quot;</span>
    <span class="n">encoding</span> <span class="o">=</span> <span class="n">_get_encoding</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">doc</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">_encode</span><span class="p">(</span><span class="n">comment</span><span class="p">(</span><span class="n">doc</span><span class="p">),</span> <span class="n">encoding</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="n">section</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>
    <span class="n">ini_format</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">encoding</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">ini_format</span><span class="p">(</span><span class="n">stream</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">StringIO</span><span class="p">,</span> <span class="n">TextIOWrapper</span><span class="p">],</span> <span class="n">options</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;format options using the INI format&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">optname</span><span class="p">,</span> <span class="n">optdict</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">format_option_value</span><span class="p">(</span><span class="n">optdict</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">optdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;help&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">help</span><span class="p">:</span>
            <span class="n">help</span> <span class="o">=</span> <span class="n">normalize_text</span><span class="p">(</span><span class="n">help</span><span class="p">,</span> <span class="n">line_len</span><span class="o">=</span><span class="mi">79</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="s2">&quot;# &quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">_encode</span><span class="p">(</span><span class="n">help</span><span class="p">,</span> <span class="n">encoding</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;#</span><span class="si">%s</span><span class="s2">=&quot;</span> <span class="o">%</span> <span class="n">optname</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">_encode</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">encoding</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">optdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span> <span class="ow">and</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    &quot;</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">prefix</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">optname</span><span class="p">,</span> <span class="n">value</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>


<span class="n">format_section</span> <span class="o">=</span> <span class="n">ini_format_section</span>


<span class="k">def</span> <span class="nf">rest_format_section</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;format an options section using as ReST formatted output&quot;&quot;&quot;</span>
    <span class="n">encoding</span> <span class="o">=</span> <span class="n">_get_encoding</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">section</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">section</span><span class="p">)),</span> <span class="n">file</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">doc</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">_encode</span><span class="p">(</span><span class="n">normalize_text</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">line_len</span><span class="o">=</span><span class="mi">79</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="n">encoding</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">optname</span><span class="p">,</span> <span class="n">optdict</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">optdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;help&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;:</span><span class="si">%s</span><span class="s2">:&quot;</span> <span class="o">%</span> <span class="n">optname</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">help</span><span class="p">:</span>
            <span class="n">help</span> <span class="o">=</span> <span class="n">normalize_text</span><span class="p">(</span><span class="n">help</span><span class="p">,</span> <span class="n">line_len</span><span class="o">=</span><span class="mi">79</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="s2">&quot;  &quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">_encode</span><span class="p">(</span><span class="n">help</span><span class="p">,</span> <span class="n">encoding</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">_encode</span><span class="p">(</span><span class="n">format_option_value</span><span class="p">(</span><span class="n">optdict</span><span class="p">,</span> <span class="n">value</span><span class="p">),</span> <span class="n">encoding</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Default: ``</span><span class="si">%s</span><span class="s2">``&quot;</span> <span class="o">%</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;`` &quot;</span><span class="p">,</span> <span class="s2">&quot;```` ``&quot;</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>


<span class="c1"># Options Manager ##############################################################</span>


<div class="viewcode-block" id="OptionsManagerMixIn"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.OptionsManagerMixIn">[docs]</a><span class="k">class</span> <span class="nc">OptionsManagerMixIn</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;MixIn to handle a configuration from both a configuration file and</span>
<span class="sd">    command line options</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">usage</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">config_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">quiet</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_file</span> <span class="o">=</span> <span class="n">config_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_parsers</span><span class="p">(</span><span class="n">usage</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">)</span>
        <span class="c1"># list of registered options providers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options_providers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ConfigurationMixIn</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># dictionary associating option name to checker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_options</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ConfigurationMixIn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_short_options</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nocallback_options</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">ConfigurationMixIn</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mygroups</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">optik_ext</span><span class="o">.</span><span class="n">OptionGroup</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># verbosity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="n">quiet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_maxlevel</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="OptionsManagerMixIn.reset_parsers"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.OptionsManagerMixIn.reset_parsers">[docs]</a>    <span class="k">def</span> <span class="nf">reset_parsers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">usage</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># configuration file parser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfgfile_parser</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
        <span class="c1"># command line parser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmdline_parser</span> <span class="o">=</span> <span class="n">optik_ext</span><span class="o">.</span><span class="n">OptionParser</span><span class="p">(</span><span class="n">usage</span><span class="o">=</span><span class="n">usage</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">)</span>
        <span class="c1"># mypy: &quot;OptionParser&quot; has no attribute &quot;options_manager&quot;</span>
        <span class="c1"># dynamic attribute?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmdline_parser</span><span class="o">.</span><span class="n">options_manager</span> <span class="o">=</span> <span class="bp">self</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_optik_option_attrs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cmdline_parser</span><span class="o">.</span><span class="n">option_class</span><span class="o">.</span><span class="n">ATTRS</span><span class="p">)</span></div>

<div class="viewcode-block" id="OptionsManagerMixIn.register_options_provider"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.OptionsManagerMixIn.register_options_provider">[docs]</a>    <span class="k">def</span> <span class="nf">register_options_provider</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">provider</span><span class="p">:</span> <span class="s2">&quot;ConfigurationMixIn&quot;</span><span class="p">,</span> <span class="n">own_group</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;register an options provider&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">provider</span><span class="o">.</span><span class="n">priority</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;provider&#39;s priority can&#39;t be &gt;= 0&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options_providers</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">provider</span><span class="o">.</span><span class="n">priority</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">options_providers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">priority</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">options_providers</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">provider</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options_providers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">provider</span><span class="p">)</span>

        <span class="c1"># mypy: Need type annotation for &#39;option&#39;</span>
        <span class="c1"># you can&#39;t type variable of a list comprehension, right?</span>
        <span class="n">non_group_spec_options</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">option</span> <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">provider</span><span class="o">.</span><span class="n">options</span> <span class="k">if</span> <span class="s2">&quot;group&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">option</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
        <span class="p">]</span>  <span class="c1"># type: ignore</span>

        <span class="n">groups</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="s2">&quot;option_groups&quot;</span><span class="p">,</span> <span class="p">())</span>
        <span class="k">if</span> <span class="n">own_group</span> <span class="ow">and</span> <span class="n">non_group_spec_options</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_option_group</span><span class="p">(</span>
                <span class="n">provider</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">provider</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">,</span> <span class="n">non_group_spec_options</span><span class="p">,</span> <span class="n">provider</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">opt</span><span class="p">,</span> <span class="n">optdict</span> <span class="ow">in</span> <span class="n">non_group_spec_options</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_optik_option</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmdline_parser</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">optdict</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">gname</span><span class="p">,</span> <span class="n">gdoc</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
            <span class="n">gname</span> <span class="o">=</span> <span class="n">gname</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

            <span class="c1"># mypy: Need type annotation for &#39;option&#39;</span>
            <span class="c1"># you can&#39;t type variable of a list comprehension, right?</span>
            <span class="n">goptions</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">option</span>
                <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">provider</span><span class="o">.</span><span class="n">options</span>  <span class="c1"># type: ignore</span>
                <span class="k">if</span> <span class="n">option</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;group&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">gname</span>
            <span class="p">]</span>  <span class="c1"># type: ignore</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_option_group</span><span class="p">(</span><span class="n">gname</span><span class="p">,</span> <span class="n">gdoc</span><span class="p">,</span> <span class="n">goptions</span><span class="p">,</span> <span class="n">provider</span><span class="p">)</span></div>

<div class="viewcode-block" id="OptionsManagerMixIn.add_option_group"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.OptionsManagerMixIn.add_option_group">[docs]</a>    <span class="k">def</span> <span class="nf">add_option_group</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">group_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">doc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">options</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]],</span>
        <span class="n">provider</span><span class="p">:</span> <span class="s2">&quot;ConfigurationMixIn&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;add an option group including the listed options&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">options</span>
        <span class="c1"># add option group to the command line parser</span>
        <span class="k">if</span> <span class="n">group_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mygroups</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mygroups</span><span class="p">[</span><span class="n">group_name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">optik_ext</span><span class="o">.</span><span class="n">OptionGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cmdline_parser</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">group_name</span><span class="o">.</span><span class="n">capitalize</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cmdline_parser</span><span class="o">.</span><span class="n">add_option_group</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
            <span class="c1"># mypy: &quot;OptionGroup&quot; has no attribute &quot;level&quot;</span>
            <span class="c1"># dynamic attribute</span>
            <span class="n">group</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">level</span>  <span class="c1"># type: ignore</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mygroups</span><span class="p">[</span><span class="n">group_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span>
            <span class="c1"># add section to the config file</span>
            <span class="k">if</span> <span class="n">group_name</span> <span class="o">!=</span> <span class="s2">&quot;DEFAULT&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cfgfile_parser</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="n">group_name</span><span class="p">)</span>
        <span class="c1"># add provider&#39;s specific options</span>
        <span class="k">for</span> <span class="n">opt</span><span class="p">,</span> <span class="n">optdict</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_optik_option</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">optdict</span><span class="p">)</span></div>

<div class="viewcode-block" id="OptionsManagerMixIn.add_optik_option"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.OptionsManagerMixIn.add_optik_option">[docs]</a>    <span class="k">def</span> <span class="nf">add_optik_option</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">provider</span><span class="p">:</span> <span class="s2">&quot;ConfigurationMixIn&quot;</span><span class="p">,</span>
        <span class="n">optikcontainer</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">OptionParser</span><span class="p">,</span> <span class="n">OptionGroup</span><span class="p">],</span>
        <span class="n">opt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">optdict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;inputlevel&quot;</span> <span class="ow">in</span> <span class="n">optdict</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span>
                <span class="s1">&#39;[0.50] &quot;inputlevel&quot; in option dictionary for </span><span class="si">%s</span><span class="s1"> is deprecated,&#39;</span>
                <span class="s1">&#39; use &quot;level&quot;&#39;</span> <span class="o">%</span> <span class="n">opt</span><span class="p">,</span>
                <span class="ne">DeprecationWarning</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">optdict</span><span class="p">[</span><span class="s2">&quot;level&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optdict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;inputlevel&quot;</span><span class="p">)</span>
        <span class="n">args</span><span class="p">,</span> <span class="n">optdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optik_option</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">optdict</span><span class="p">)</span>
        <span class="n">option</span> <span class="o">=</span> <span class="n">optikcontainer</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">optdict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_options</span><span class="p">[</span><span class="n">opt</span><span class="p">]</span> <span class="o">=</span> <span class="n">provider</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_maxlevel</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_maxlevel</span><span class="p">,</span> <span class="n">option</span><span class="o">.</span><span class="n">level</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="OptionsManagerMixIn.optik_option"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.OptionsManagerMixIn.optik_option">[docs]</a>    <span class="k">def</span> <span class="nf">optik_option</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">provider</span><span class="p">:</span> <span class="s2">&quot;ConfigurationMixIn&quot;</span><span class="p">,</span> <span class="n">opt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">optdict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;get our personal option definition and return a suitable form for</span>
<span class="sd">        use with optik/optparse</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">optdict</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">optdict</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;action&quot;</span> <span class="ow">in</span> <span class="n">optdict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nocallback_options</span><span class="p">[</span><span class="n">provider</span><span class="p">]</span> <span class="o">=</span> <span class="n">opt</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">optdict</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;callback&quot;</span>
            <span class="n">optdict</span><span class="p">[</span><span class="s2">&quot;callback&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cb_set_provider_option</span>
        <span class="c1"># default is handled here and *must not* be given to optik if you</span>
        <span class="c1"># want the whole machinery to work</span>
        <span class="k">if</span> <span class="s2">&quot;default&quot;</span> <span class="ow">in</span> <span class="n">optdict</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="s2">&quot;help&quot;</span> <span class="ow">in</span> <span class="n">optdict</span>
                <span class="ow">and</span> <span class="n">optdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">optdict</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="s2">&quot;store_false&quot;</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">optdict</span><span class="p">[</span><span class="s2">&quot;help&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot; [current: </span><span class="si">%d</span><span class="s2">efault]&quot;</span>
            <span class="k">del</span> <span class="n">optdict</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;--&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">opt</span><span class="p">)]</span>
        <span class="k">if</span> <span class="s2">&quot;short&quot;</span> <span class="ow">in</span> <span class="n">optdict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_short_options</span><span class="p">[</span><span class="n">optdict</span><span class="p">[</span><span class="s2">&quot;short&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">opt</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">optdict</span><span class="p">[</span><span class="s2">&quot;short&quot;</span><span class="p">])</span>
            <span class="k">del</span> <span class="n">optdict</span><span class="p">[</span><span class="s2">&quot;short&quot;</span><span class="p">]</span>
        <span class="c1"># cleanup option definition dict before giving it to optik</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">optdict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optik_option_attrs</span><span class="p">:</span>
                <span class="n">optdict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">args</span><span class="p">,</span> <span class="n">optdict</span></div>

<div class="viewcode-block" id="OptionsManagerMixIn.cb_set_provider_option"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.OptionsManagerMixIn.cb_set_provider_option">[docs]</a>    <span class="k">def</span> <span class="nf">cb_set_provider_option</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">:</span> <span class="s2">&quot;Option&quot;</span><span class="p">,</span> <span class="n">opt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">parser</span><span class="p">:</span> <span class="s2">&quot;OptionParser&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;optik callback for option setting&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;--&quot;</span><span class="p">):</span>
            <span class="c1"># remove -- on long option</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="n">opt</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># short option, get its long equivalent</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_short_options</span><span class="p">[</span><span class="n">opt</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="c1"># trick since we can&#39;t set action=&#39;store_true&#39; on options</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_set_option</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="OptionsManagerMixIn.global_set_option"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.OptionsManagerMixIn.global_set_option">[docs]</a>    <span class="k">def</span> <span class="nf">global_set_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;set option on the correct option provider&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_options</span><span class="p">[</span><span class="n">opt</span><span class="p">]</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="OptionsManagerMixIn.generate_config"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.OptionsManagerMixIn.generate_config">[docs]</a>    <span class="k">def</span> <span class="nf">generate_config</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">stream</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">StringIO</span><span class="p">,</span> <span class="n">TextIOWrapper</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">skipsections</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[()]</span> <span class="o">=</span> <span class="p">(),</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;write a configuration file according to the current configuration</span>
<span class="sd">        into the given stream or stdout</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">options_by_section</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">provider</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options_providers</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">section</span><span class="p">,</span> <span class="n">options</span> <span class="ow">in</span> <span class="n">provider</span><span class="o">.</span><span class="n">options_by_section</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">section</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">section</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">name</span>
                <span class="k">if</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">skipsections</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">options</span> <span class="o">=</span> <span class="p">[(</span><span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">options</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">section</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">:</span>
                    <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
                <span class="n">alloptions</span> <span class="o">=</span> <span class="n">options_by_section</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">alloptions</span> <span class="o">+=</span> <span class="n">options</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="n">stream</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="n">_get_encoding</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span>
        <span class="n">printed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">printed</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>
            <span class="n">format_section</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">section</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">options_by_section</span><span class="p">[</span><span class="n">section</span><span class="p">],</span> <span class="n">encoding</span><span class="p">)</span>
            <span class="n">printed</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="OptionsManagerMixIn.generate_manpage"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.OptionsManagerMixIn.generate_manpage">[docs]</a>    <span class="k">def</span> <span class="nf">generate_manpage</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">pkginfo</span><span class="p">:</span> <span class="n">attrdict</span><span class="p">,</span> <span class="n">section</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">stream</span><span class="p">:</span> <span class="n">StringIO</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;write a man page for the current configuration into the given</span>
<span class="sd">        stream or stdout</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_monkeypatch_expand_default</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">optik_ext</span><span class="o">.</span><span class="n">generate_manpage</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cmdline_parser</span><span class="p">,</span>
                <span class="n">pkginfo</span><span class="p">,</span>
                <span class="n">section</span><span class="p">,</span>
                <span class="n">stream</span><span class="o">=</span><span class="n">stream</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
                <span class="n">level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_maxlevel</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unmonkeypatch_expand_default</span><span class="p">()</span></div>

    <span class="c1"># initialization methods ##################################################</span>

<div class="viewcode-block" id="OptionsManagerMixIn.load_provider_defaults"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.OptionsManagerMixIn.load_provider_defaults">[docs]</a>    <span class="k">def</span> <span class="nf">load_provider_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;initialize configuration using default values&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">provider</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options_providers</span><span class="p">:</span>
            <span class="n">provider</span><span class="o">.</span><span class="n">load_defaults</span><span class="p">()</span></div>

<div class="viewcode-block" id="OptionsManagerMixIn.load_file_configuration"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.OptionsManagerMixIn.load_file_configuration">[docs]</a>    <span class="k">def</span> <span class="nf">load_file_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;load the configuration from file&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_config_file</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_config_file</span><span class="p">()</span></div>

<div class="viewcode-block" id="OptionsManagerMixIn.read_config_file"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.OptionsManagerMixIn.read_config_file">[docs]</a>    <span class="k">def</span> <span class="nf">read_config_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;read the configuration file but do not load it (i.e. dispatching</span>
<span class="sd">        values to each options provider)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">helplevel</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">helplevel</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maxlevel</span><span class="p">:</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;long&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">helplevel</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;-help&quot;</span>
            <span class="k">if</span> <span class="n">opt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_options</span><span class="p">:</span>
                <span class="k">break</span>  <span class="c1"># already processed</span>

            <span class="k">def</span> <span class="nf">helpfunc</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">helplevel</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">help</span><span class="p">(</span><span class="n">level</span><span class="p">))</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">helpmsg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> verbose help.&quot;</span> <span class="o">%</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;more&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">helplevel</span><span class="p">)</span>
            <span class="n">optdict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;callback&quot;</span><span class="p">,</span> <span class="s2">&quot;callback&quot;</span><span class="p">:</span> <span class="n">helpfunc</span><span class="p">,</span> <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="n">helpmsg</span><span class="p">}</span>
            <span class="n">provider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options_providers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_optik_option</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmdline_parser</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">optdict</span><span class="p">)</span>
            <span class="n">provider</span><span class="o">.</span><span class="n">options</span> <span class="o">+=</span> <span class="p">((</span><span class="n">opt</span><span class="p">,</span> <span class="n">optdict</span><span class="p">),)</span>
            <span class="n">helplevel</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">config_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_file</span>
        <span class="k">if</span> <span class="n">config_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config_file</span> <span class="o">=</span> <span class="n">expanduser</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config_file</span> <span class="ow">and</span> <span class="n">exists</span><span class="p">(</span><span class="n">config_file</span><span class="p">):</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfgfile_parser</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">read</span><span class="p">([</span><span class="n">config_file</span><span class="p">])</span>
            <span class="c1"># normalize sections&#39;title</span>
            <span class="c1"># mypy: &quot;ConfigParser&quot; has no attribute &quot;_sections&quot;</span>
            <span class="c1"># dynamic attribute?</span>
            <span class="k">for</span> <span class="n">sect</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">_sections</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>  <span class="c1"># type: ignore</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">sect</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="ow">and</span> <span class="n">values</span><span class="p">:</span>
                    <span class="n">parser</span><span class="o">.</span><span class="n">_sections</span><span class="p">[</span><span class="n">sect</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="o">=</span> <span class="n">values</span>  <span class="c1"># type: ignore</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No config file found, using default configuration&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">return</span></div>

<div class="viewcode-block" id="OptionsManagerMixIn.input_config"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.OptionsManagerMixIn.input_config">[docs]</a>    <span class="k">def</span> <span class="nf">input_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">onlysection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inputlevel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;interactively get configuration values by asking to the user and generate</span>
<span class="sd">        a configuration file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">onlysection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">onlysection</span> <span class="o">=</span> <span class="n">onlysection</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">provider</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options_providers</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">optdict</span> <span class="ow">in</span> <span class="n">provider</span><span class="o">.</span><span class="n">all_options</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">onlysection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">section</span> <span class="o">!=</span> <span class="n">onlysection</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="s2">&quot;type&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">optdict</span><span class="p">:</span>
                    <span class="c1"># ignore action without type (callback, store_true...)</span>
                    <span class="k">continue</span>
                <span class="n">provider</span><span class="o">.</span><span class="n">input_option</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">optdict</span><span class="p">,</span> <span class="n">inputlevel</span><span class="p">)</span>
        <span class="c1"># now we can generate the configuration file</span>
        <span class="k">if</span> <span class="n">stream</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generate_config</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span></div>

<div class="viewcode-block" id="OptionsManagerMixIn.load_config_file"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.OptionsManagerMixIn.load_config_file">[docs]</a>    <span class="k">def</span> <span class="nf">load_config_file</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;dispatch values previously read from a configuration file to each</span>
<span class="sd">        options provider)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfgfile_parser</span>
        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">sections</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">option</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="n">section</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">global_set_option</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="n">OptionError</span><span class="p">):</span>
                    <span class="c1"># TODO handle here undeclared options appearing in the config file</span>
                    <span class="k">continue</span></div>

<div class="viewcode-block" id="OptionsManagerMixIn.load_configuration"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.OptionsManagerMixIn.load_configuration">[docs]</a>    <span class="k">def</span> <span class="nf">load_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;override configuration according to given parameters&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">opt</span><span class="p">,</span> <span class="n">opt_value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
            <span class="n">provider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_options</span><span class="p">[</span><span class="n">opt</span><span class="p">]</span>
            <span class="n">provider</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">opt_value</span><span class="p">)</span></div>

<div class="viewcode-block" id="OptionsManagerMixIn.load_command_line_configuration"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.OptionsManagerMixIn.load_command_line_configuration">[docs]</a>    <span class="k">def</span> <span class="nf">load_command_line_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;override configuration according to command line parameters</span>

<span class="sd">        return additional arguments</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_monkeypatch_expand_default</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmdline_parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">provider</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nocallback_options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">config</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">config</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">args</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unmonkeypatch_expand_default</span><span class="p">()</span></div>

    <span class="c1"># help methods ############################################################</span>

<div class="viewcode-block" id="OptionsManagerMixIn.add_help_section"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.OptionsManagerMixIn.add_help_section">[docs]</a>    <span class="k">def</span> <span class="nf">add_help_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;add a dummy option section for help purpose&quot;&quot;&quot;</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">optik_ext</span><span class="o">.</span><span class="n">OptionGroup</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cmdline_parser</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="o">.</span><span class="n">capitalize</span><span class="p">(),</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span>
        <span class="p">)</span>
        <span class="c1"># mypy: &quot;OptionGroup&quot; has no attribute &quot;level&quot;</span>
        <span class="c1"># it does, it is set in the optik_ext module</span>
        <span class="n">group</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">level</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_maxlevel</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_maxlevel</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmdline_parser</span><span class="o">.</span><span class="n">add_option_group</span><span class="p">(</span><span class="n">group</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_monkeypatch_expand_default</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># monkey patch optik_ext to deal with our default values</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__expand_default_backup</span> <span class="o">=</span> <span class="n">optik_ext</span><span class="o">.</span><span class="n">HelpFormatter</span><span class="o">.</span><span class="n">expand_default</span>
            <span class="c1"># mypy: Cannot assign to a method</span>
            <span class="c1"># it&#39;s dirty but you can</span>
            <span class="n">optik_ext</span><span class="o">.</span><span class="n">HelpFormatter</span><span class="o">.</span><span class="n">expand_default</span> <span class="o">=</span> <span class="n">expand_default</span>  <span class="c1"># type: ignore</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c1"># python &lt; 2.4: nothing to be done</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_unmonkeypatch_expand_default</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># remove monkey patch</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">optik_ext</span><span class="o">.</span><span class="n">HelpFormatter</span><span class="p">,</span> <span class="s2">&quot;expand_default&quot;</span><span class="p">):</span>
            <span class="c1"># mypy: Cannot assign to a method</span>
            <span class="c1"># it&#39;s dirty but you can</span>

            <span class="c1"># unpatch optik_ext to avoid side effects</span>
            <span class="n">optik_ext</span><span class="o">.</span><span class="n">HelpFormatter</span><span class="o">.</span><span class="n">expand_default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__expand_default_backup</span>  <span class="c1"># type: ignore</span>

<div class="viewcode-block" id="OptionsManagerMixIn.help"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.OptionsManagerMixIn.help">[docs]</a>    <span class="k">def</span> <span class="nf">help</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;return the usage string for available options&quot;&quot;&quot;</span>
        <span class="c1"># mypy: &quot;HelpFormatter&quot; has no attribute &quot;output_level&quot;</span>
        <span class="c1"># set in optik_ext</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmdline_parser</span><span class="o">.</span><span class="n">formatter</span><span class="o">.</span><span class="n">output_level</span> <span class="o">=</span> <span class="n">level</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_monkeypatch_expand_default</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmdline_parser</span><span class="o">.</span><span class="n">format_help</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unmonkeypatch_expand_default</span><span class="p">()</span></div></div>


<span class="k">class</span> <span class="nc">Method</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;used to ease late binding of default method (so you can define options</span>
<span class="sd">    on the class using default methods on the configuration instance)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methname</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">methname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inst</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="s2">&quot;Configuration&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;bind the method to its instance&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inst</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inst</span> <span class="o">=</span> <span class="n">instance</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inst</span><span class="p">,</span> <span class="s2">&quot;unbound method&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="c1"># Options Provider #############################################################</span>


<div class="viewcode-block" id="OptionsProviderMixIn"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.OptionsProviderMixIn">[docs]</a><span class="k">class</span> <span class="nc">OptionsProviderMixIn</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mixin to provide options to an OptionsManager&quot;&quot;&quot;</span>

    <span class="c1"># those attributes should be overridden</span>
    <span class="n">priority</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
    <span class="n">options</span><span class="p">:</span> <span class="n">Tuple</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">optik_ext</span><span class="o">.</span><span class="n">Values</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">option_tuple</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">option</span><span class="p">,</span> <span class="n">optdict</span> <span class="o">=</span> <span class="n">option_tuple</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad option: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">option_tuple</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">optdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">),</span> <span class="n">Method</span><span class="p">):</span>
                <span class="n">optdict</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">optdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;callback&quot;</span><span class="p">),</span> <span class="n">Method</span><span class="p">):</span>
                <span class="n">optdict</span><span class="p">[</span><span class="s2">&quot;callback&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_defaults</span><span class="p">()</span>

<div class="viewcode-block" id="OptionsProviderMixIn.load_defaults"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.OptionsProviderMixIn.load_defaults">[docs]</a>    <span class="k">def</span> <span class="nf">load_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;initialize the provider using default values&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">opt</span><span class="p">,</span> <span class="n">optdict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">:</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">optdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">action</span> <span class="o">!=</span> <span class="s2">&quot;callback&quot;</span><span class="p">:</span>
                <span class="c1"># callback action have no default</span>
                <span class="n">default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_default</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">optdict</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="n">REQUIRED</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">optdict</span><span class="p">)</span></div>

<div class="viewcode-block" id="OptionsProviderMixIn.option_default"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.OptionsProviderMixIn.option_default">[docs]</a>    <span class="k">def</span> <span class="nf">option_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">optdict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return the default value for an option&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">optdict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">optdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_option_def</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
        <span class="n">default</span> <span class="o">=</span> <span class="n">optdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">default</span><span class="p">):</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">default</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">default</span></div>

<div class="viewcode-block" id="OptionsProviderMixIn.option_attrname"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.OptionsProviderMixIn.option_attrname">[docs]</a>    <span class="k">def</span> <span class="nf">option_attrname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">optdict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get the config attribute corresponding to opt&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">optdict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">optdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_option_def</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">optdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dest&quot;</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">))</span></div>

    <span class="n">option_name</span> <span class="o">=</span> <span class="n">callable_deprecated</span><span class="p">(</span>
        <span class="s2">&quot;[0.60] OptionsProviderMixIn.option_name() was renamed to option_attrname()&quot;</span>
    <span class="p">)(</span><span class="n">option_attrname</span><span class="p">)</span>

<div class="viewcode-block" id="OptionsProviderMixIn.option_value"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.OptionsProviderMixIn.option_value">[docs]</a>    <span class="k">def</span> <span class="nf">option_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get the current value for the given option&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_attrname</span><span class="p">(</span><span class="n">opt</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="OptionsProviderMixIn.set_option"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.OptionsProviderMixIn.set_option">[docs]</a>    <span class="k">def</span> <span class="nf">set_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">optdict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;method called to set an option (registered in the options list)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">optdict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">optdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_option_def</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">_validate</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">optdict</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">optdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="s2">&quot;store&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">optdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;named&quot;</span><span class="p">:</span>  <span class="c1"># XXX need specific handling</span>
            <span class="n">optname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_attrname</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">optdict</span><span class="p">)</span>
            <span class="n">currentvalue</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">optname</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">currentvalue</span><span class="p">:</span>
                <span class="n">currentvalue</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">currentvalue</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;store&quot;</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_attrname</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">optdict</span><span class="p">),</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_attrname</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">optdict</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;store_false&quot;</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_attrname</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">optdict</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;append&quot;</span><span class="p">:</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_attrname</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">optdict</span><span class="p">)</span>
            <span class="n">_list</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="n">_list</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">_list</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">_list</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">_list</span> <span class="o">+</span> <span class="p">(</span><span class="n">value</span><span class="p">,))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;callback&quot;</span><span class="p">:</span>
            <span class="n">optdict</span><span class="p">[</span><span class="s2">&quot;callback&quot;</span><span class="p">](</span><span class="kc">None</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UnsupportedAction</span><span class="p">(</span><span class="n">action</span><span class="p">)</span></div>

<div class="viewcode-block" id="OptionsProviderMixIn.input_option"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.OptionsProviderMixIn.input_option">[docs]</a>    <span class="k">def</span> <span class="nf">input_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">optdict</span><span class="p">,</span> <span class="n">inputlevel</span><span class="o">=</span><span class="mi">99</span><span class="p">):</span>
        <span class="n">default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_default</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">optdict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="n">REQUIRED</span><span class="p">:</span>
            <span class="n">defaultstr</span> <span class="o">=</span> <span class="s2">&quot;(required): &quot;</span>
        <span class="k">elif</span> <span class="n">optdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;level&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">inputlevel</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">optdict</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;password&quot;</span> <span class="ow">or</span> <span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">defaultstr</span> <span class="o">=</span> <span class="s2">&quot;: &quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">defaultstr</span> <span class="o">=</span> <span class="s2">&quot;(default: </span><span class="si">%s</span><span class="s2">): &quot;</span> <span class="o">%</span> <span class="n">format_option_value</span><span class="p">(</span><span class="n">optdict</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;:</span><span class="si">%s</span><span class="s2">:&quot;</span> <span class="o">%</span> <span class="n">option</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">optdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;help&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">option</span><span class="p">)</span>
        <span class="n">inputfunc</span> <span class="o">=</span> <span class="n">INPUT_FUNCTIONS</span><span class="p">[</span><span class="n">optdict</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">inputfunc</span><span class="p">(</span><span class="n">optdict</span><span class="p">,</span> <span class="n">defaultstr</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">default</span> <span class="ow">is</span> <span class="n">REQUIRED</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;please specify a value&quot;</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">inputfunc</span><span class="p">(</span><span class="n">optdict</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: &quot;</span> <span class="o">%</span> <span class="n">option</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">optdict</span><span class="o">=</span><span class="n">optdict</span><span class="p">)</span></div>

<div class="viewcode-block" id="OptionsProviderMixIn.get_option_def"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.OptionsProviderMixIn.get_option_def">[docs]</a>    <span class="k">def</span> <span class="nf">get_option_def</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return the dictionary defining an option given it&#39;s name&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span>
        <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">option</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">opt</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">option</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># mypy: Argument 2 to &quot;OptionError&quot; has incompatible type &quot;str&quot;; expected &quot;Option&quot;</span>
        <span class="c1"># seems to be working?</span>
        <span class="n">similar_options</span> <span class="o">=</span> <span class="n">get_close_matches</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">),</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">similar_options</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">OptionError</span><span class="p">(</span>
                <span class="s2">&quot;no such option </span><span class="si">%s</span><span class="s2"> in section </span><span class="si">%r</span><span class="s2">.</span><span class="se">\n\n</span><span class="s2">Options with a similar name are:</span><span class="se">\n</span><span class="s2"> * </span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> * &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">similar_options</span><span class="p">)),</span>
                <span class="n">opt</span><span class="p">,</span>
            <span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">OptionError</span><span class="p">(</span>
                <span class="s2">&quot;no such option </span><span class="si">%s</span><span class="s2"> in section </span><span class="si">%r</span><span class="s2">.</span><span class="se">\n\n</span><span class="s2">No option with a similar name, &quot;</span>
                <span class="s2">&quot;all available options:</span><span class="se">\n</span><span class="s2"> * </span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> * &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)),</span>
                <span class="n">opt</span><span class="p">,</span>
            <span class="p">)</span>  <span class="c1"># type: ignore</span></div>

<div class="viewcode-block" id="OptionsProviderMixIn.all_options"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.OptionsProviderMixIn.all_options">[docs]</a>    <span class="k">def</span> <span class="nf">all_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return an iterator on available options for this provider</span>
<span class="sd">        option are actually described by a 3-uple:</span>
<span class="sd">        (section, option name, option dictionary)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">section</span><span class="p">,</span> <span class="n">options</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options_by_section</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">section</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">option</span><span class="p">,</span> <span class="n">optiondict</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">optiondict</span></div>

<div class="viewcode-block" id="OptionsProviderMixIn.options_by_section"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.OptionsProviderMixIn.options_by_section">[docs]</a>    <span class="k">def</span> <span class="nf">options_by_section</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;return an iterator on options grouped by section</span>

<span class="sd">        (section, [list of (optname, optdict, optvalue)])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sections</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">optname</span><span class="p">,</span> <span class="n">optdict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">:</span>
            <span class="n">sections</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">optdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;group&quot;</span><span class="p">),</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="n">optname</span><span class="p">,</span> <span class="n">optdict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_value</span><span class="p">(</span><span class="n">optname</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">:</span>
            <span class="c1"># mypy: No overload variant of &quot;pop&quot; of &quot;MutableMapping&quot; matches argument type &quot;None&quot;</span>
            <span class="c1"># it actually works</span>
            <span class="k">yield</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sections</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="k">for</span> <span class="n">section</span><span class="p">,</span> <span class="n">options</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">sections</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">yield</span> <span class="n">section</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">options</span></div>

<div class="viewcode-block" id="OptionsProviderMixIn.options_and_values"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.OptionsProviderMixIn.options_and_values">[docs]</a>    <span class="k">def</span> <span class="nf">options_and_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span>
        <span class="k">for</span> <span class="n">optname</span><span class="p">,</span> <span class="n">optdict</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">optname</span><span class="p">,</span> <span class="n">optdict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_value</span><span class="p">(</span><span class="n">optname</span><span class="p">))</span></div></div>


<span class="c1"># configuration ################################################################</span>


<div class="viewcode-block" id="ConfigurationMixIn"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.ConfigurationMixIn">[docs]</a><span class="k">class</span> <span class="nc">ConfigurationMixIn</span><span class="p">(</span><span class="n">OptionsManagerMixIn</span><span class="p">,</span> <span class="n">OptionsProviderMixIn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;basic mixin for simple configurations which don&#39;t need the</span>
<span class="sd">    manager / providers model</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;usage&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;quiet&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">OptionsManagerMixIn</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">OptionsProviderMixIn</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;option_groups&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">option_groups</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">option</span><span class="p">,</span> <span class="n">optdict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">gdef</span> <span class="o">=</span> <span class="p">(</span><span class="n">optdict</span><span class="p">[</span><span class="s2">&quot;group&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">gdef</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_groups</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">option_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gdef</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_options_provider</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">own_group</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<div class="viewcode-block" id="ConfigurationMixIn.register_options"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.ConfigurationMixIn.register_options">[docs]</a>    <span class="k">def</span> <span class="nf">register_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;add some options to the configuration&quot;&quot;&quot;</span>
        <span class="n">options_by_group</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">optname</span><span class="p">,</span> <span class="n">optdict</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
            <span class="n">options_by_group</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">optdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;group&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()),</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="n">optname</span><span class="p">,</span> <span class="n">optdict</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">group_options</span> <span class="ow">in</span> <span class="n">options_by_group</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_option_group</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">group_options</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">+=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">options</span><span class="p">)</span></div>

<div class="viewcode-block" id="ConfigurationMixIn.load_defaults"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.ConfigurationMixIn.load_defaults">[docs]</a>    <span class="k">def</span> <span class="nf">load_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">OptionsProviderMixIn</span><span class="o">.</span><span class="n">load_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_attrname</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">optik_ext</span><span class="o">.</span><span class="n">OptionValueError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="ConfigurationMixIn.get"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.ConfigurationMixIn.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">OptionError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">default</span></div></div>


<div class="viewcode-block" id="Configuration"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.Configuration">[docs]</a><span class="k">class</span> <span class="nc">Configuration</span><span class="p">(</span><span class="n">ConfigurationMixIn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;class for simple configurations which don&#39;t need the</span>
<span class="sd">    manager / providers model and prefer delegation to inheritance</span>

<span class="sd">    configuration values are accessible through a dict like interface</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">config_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">usage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">if</span> <span class="n">doc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">doc</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Configuration</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config_file</span><span class="o">=</span><span class="n">config_file</span><span class="p">,</span> <span class="n">usage</span><span class="o">=</span><span class="n">usage</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">)</span></div>


<div class="viewcode-block" id="OptionsManager2ConfigurationAdapter"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.OptionsManager2ConfigurationAdapter">[docs]</a><span class="k">class</span> <span class="nc">OptionsManager2ConfigurationAdapter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adapt an option manager to behave like a</span>
<span class="sd">    `logilab.common.configuration.Configuration` instance</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">provider</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">_all_options</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">provider</span><span class="o">.</span><span class="n">option_attrname</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">global_set_option</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">option_attrname</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="OptionsManager2ConfigurationAdapter.get"><a class="viewcode-back" href="../../../logilab.common.html#logilab.common.configuration.OptionsManager2ConfigurationAdapter.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span></div></div>


<span class="c1"># other functions ##############################################################</span>


<span class="k">def</span> <span class="nf">read_old_config</span><span class="p">(</span><span class="n">newconfig</span><span class="p">,</span> <span class="n">changes</span><span class="p">,</span> <span class="n">configfile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;initialize newconfig from a deprecated configuration file</span>

<span class="sd">    possible changes:</span>
<span class="sd">    * (&#39;renamed&#39;, oldname, newname)</span>
<span class="sd">    * (&#39;moved&#39;, option, oldgroup, newgroup)</span>
<span class="sd">    * (&#39;typechanged&#39;, option, oldtype, newvalue)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># build an index of changes</span>
    <span class="n">changesindex</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;moved&quot;</span><span class="p">:</span>
            <span class="n">option</span><span class="p">,</span> <span class="n">oldgroup</span><span class="p">,</span> <span class="n">newgroup</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">changesindex</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">oldgroup</span><span class="p">,</span> <span class="n">newgroup</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;renamed&quot;</span><span class="p">:</span>
            <span class="n">oldname</span><span class="p">,</span> <span class="n">newname</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">changesindex</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">newname</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">oldname</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;typechanged&quot;</span><span class="p">:</span>
            <span class="n">option</span><span class="p">,</span> <span class="n">oldtype</span><span class="p">,</span> <span class="n">newvalue</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">changesindex</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">oldtype</span><span class="p">,</span> <span class="n">newvalue</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;added&quot;</span><span class="p">,</span> <span class="s2">&quot;removed&quot;</span><span class="p">):</span>
            <span class="k">continue</span>  <span class="c1"># nothing to do here</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;unknown change </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># build a config object able to read the old config</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">optname</span><span class="p">,</span> <span class="n">optdef</span> <span class="ow">in</span> <span class="n">newconfig</span><span class="o">.</span><span class="n">options</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">changesindex</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">optname</span><span class="p">,</span> <span class="p">()):</span>
            <span class="k">if</span> <span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;moved&quot;</span><span class="p">:</span>
                <span class="n">oldgroup</span><span class="p">,</span> <span class="n">newgroup</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">optdef</span> <span class="o">=</span> <span class="n">optdef</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">optdef</span><span class="p">[</span><span class="s2">&quot;group&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">oldgroup</span>
            <span class="k">elif</span> <span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;renamed&quot;</span><span class="p">:</span>
                <span class="n">optname</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;typechanged&quot;</span><span class="p">:</span>
                <span class="n">oldtype</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">optdef</span> <span class="o">=</span> <span class="n">optdef</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">optdef</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">oldtype</span>
        <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">optname</span><span class="p">,</span> <span class="n">optdef</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">changesindex</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;unapplied changes: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">changesindex</span><span class="p">)</span>
    <span class="n">oldconfig</span> <span class="o">=</span> <span class="n">Configuration</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">newconfig</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="c1"># read the old config</span>
    <span class="n">oldconfig</span><span class="o">.</span><span class="n">load_file_configuration</span><span class="p">(</span><span class="n">configfile</span><span class="p">)</span>
    <span class="c1"># apply values reverting changes</span>
    <span class="n">changes</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
    <span class="n">done</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;renamed&quot;</span><span class="p">:</span>
            <span class="n">oldname</span><span class="p">,</span> <span class="n">newname</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">newconfig</span><span class="p">[</span><span class="n">newname</span><span class="p">]</span> <span class="o">=</span> <span class="n">oldconfig</span><span class="p">[</span><span class="n">oldname</span><span class="p">]</span>
            <span class="n">done</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">newname</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;typechanged&quot;</span><span class="p">:</span>
            <span class="n">optname</span><span class="p">,</span> <span class="n">oldtype</span><span class="p">,</span> <span class="n">newvalue</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">newconfig</span><span class="p">[</span><span class="n">optname</span><span class="p">]</span> <span class="o">=</span> <span class="n">newvalue</span>
            <span class="n">done</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">optname</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">optname</span><span class="p">,</span> <span class="n">optdef</span> <span class="ow">in</span> <span class="n">newconfig</span><span class="o">.</span><span class="n">options</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">optdef</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">optname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
            <span class="n">newconfig</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="n">optname</span><span class="p">,</span> <span class="n">oldconfig</span><span class="p">[</span><span class="n">optname</span><span class="p">],</span> <span class="n">optdict</span><span class="o">=</span><span class="n">optdef</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">merge_options</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">optgroup</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;preprocess a list of options and remove duplicates, returning a new list</span>
<span class="sd">    (tuple actually) of options.</span>

<span class="sd">    Options dictionaries are copied to avoid later side-effect. Also, if</span>
<span class="sd">    `otpgroup` argument is specified, ensure all options are in the given group.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">alloptions</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">options</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">optname</span><span class="p">,</span> <span class="n">optdict</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">optname</span> <span class="ow">in</span> <span class="n">alloptions</span><span class="p">:</span>
            <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">alloptions</span><span class="p">[</span><span class="n">optname</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">optdict</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">optdict</span> <span class="o">=</span> <span class="n">optdict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">options</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">optname</span><span class="p">,</span> <span class="n">optdict</span><span class="p">)</span>
            <span class="n">alloptions</span><span class="p">[</span><span class="n">optname</span><span class="p">]</span> <span class="o">=</span> <span class="n">optdict</span>
        <span class="k">if</span> <span class="n">optgroup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">alloptions</span><span class="p">[</span><span class="n">optname</span><span class="p">][</span><span class="s2">&quot;group&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optgroup</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">logilab common</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../logilab.common.html">logilab.common package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../logilab.common.ureports.html">logilab.common.ureports package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  <li><a href="../common.html">logilab.common</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Logilab.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>